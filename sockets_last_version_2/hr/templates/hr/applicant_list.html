{% extends "orders/base.html" %}
{% block content %}
<style>
  /* ✅ تثبيت الـ Navbar */
  .navbar {
    position: sticky;
    top: 0;
    z-index: 1050; /* يخليها فوق أي عنصر تاني */
  }
</style>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>📋 قائمة الطلبات</h3>
    <div class="d-flex gap-2">
      <a href="{% url 'hr:applicant_search_or_create' %}" class="btn btn-success">➕ تسجيل جديد</a>
      <a href="{% url 'hr:export_applicants_excel' %}?from={{ filters.from }}&to={{ filters.to }}" class="btn btn-outline-primary">⬇️ تصدير مجمع</a>
    </div>
  </div>

  <form class="row g-2 mb-3">
  <div class="col-md-2">
    <input type="date" name="from" value="{{ filters.from }}" class="form-control"
           placeholder="من" max="{{ today }}" onchange="this.form.submit()">
  </div>
  <div class="col-md-2">
    <input type="date" name="to" value="{{ filters.to }}" class="form-control"
           placeholder="إلى" max="{{ today }}" onchange="this.form.submit()">
  </div>
  <div class="col-md-2">
    <select name="status" class="form-select" onchange="this.form.submit()">
      <option value="">كل الحالات</option>
      {% for val, label in status_choices %}
        <option value="{{ val }}" {% if filters.status == val %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <input type="text" name="q" value="{{ filters.q }}" class="form-control"
           placeholder="بحث (اسم/قومي/هاتف)" onkeydown="if(event.key==='Enter'){this.form.submit()}">
  </div>
</form>


  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>#</th><th>الاسم</th><th>الهاتف</th><th>الحالة</th><th>تاريخ التقديم</th><th>تحكم</th>
        </tr>
      </thead>
      <tbody>
        {% for a in applicants %}
        <tr>
          <td class="fw-bold">#{{ a.order_number }}</td>
          <td>{{ a.full_name }}</td>
          <td>{{ a.phone }}</td>
          <td><span class="badge bg-secondary">{{ a.get_status_display }}</span></td>
          <td>{{ a.submitted_at|date:"Y-m-d H:i" }}</td>
          <td>
            <div class="btn-group">
              <a href="{% url 'hr:applicant_detail' a.order_number %}" class="btn btn-sm btn-outline-primary">عرض</a>
              <a href="{% url 'hr:applicant_edit' a.order_number %}" class="btn btn-sm btn-outline-warning">تعديل</a>
              <a href="{% url 'hr:export_applicant_excel' a.order_number %}" class="btn btn-sm btn-outline-success">إكسل</a>
              {% if perms.hr.can_delete %}{% endif %}
              {% if request.user.is_superuser %}{% endif %}
              <!-- الحذف والقرار متحكم فيه من الـ views بصلاحيات HR -->
              <a href="{% url 'hr:applicant_decision' a.order_number %}" class="btn btn-sm btn-outline-dark">قرار</a>
              <a href="{% url 'hr:applicant_delete' a.order_number %}" class="btn btn-sm btn-outline-danger">حذف</a>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="6" class="text-muted text-center">لا توجد بيانات.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script>
const hrSocket = new WebSocket(
  (window.location.protocol === "https:" ? "wss://" : "ws://") +
  window.location.host +
  "/ws/hr/applicants/"
);

hrSocket.onopen = () => console.log("✅ Connected to HR Applicants WS");

hrSocket.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log("🧾 Applicant update:", data);

  const tbody = document.querySelector("table tbody");
  if (!tbody) return;

  // ✅ إنشاء صف جديد وإضافته في أعلى الجدول
  const newRow = document.createElement("tr");
  newRow.innerHTML = `
    <td class="fw-bold">#${data.order_number}</td>
    <td>${data.full_name}</td>
    <td>${data.phone || '-'}</td>
    <td><span class="badge bg-secondary">${data.status}</span></td>
    <td>${data.submitted_at}</td>
    <td>
      <div class="btn-group">
        <a href="${data.detail_url}" class="btn btn-sm btn-outline-primary">عرض</a>
        <a href="${data.edit_url}" class="btn btn-sm btn-outline-warning">تعديل</a>
        <a href="${data.excel_url}" class="btn btn-sm btn-outline-success">إكسل</a>
        <a href="${data.decision_url}" class="btn btn-sm btn-outline-dark">قرار</a>
        <a href="${data.delete_url}" class="btn btn-sm btn-outline-danger">حذف</a>
      </div>
    </td>
  `;

  tbody.prepend(newRow);
  showToast(data.message);
};

// ✅ إشعار مؤقت
function showToast(message) {
  const toast = document.createElement("div");
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #007bff;
    color: #fff;
    padding: 10px 15px;
    border-radius: 6px;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
    z-index: 9999;
    font-size: 14px;
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}
