{% extends "orders/base.html" %}
{% block title %}ğŸ“¦ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†{% endblock %}

{% block content %}
<div class="inventory-dashboard">

    <!-- âœ… Ø§Ù„Ù‡ÙŠØ¯Ø± Ø¨Ù†ÙØ³ Ø´ÙƒÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
    <div class="header-fixed">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="m-0" style="font-size: 1.5rem;">
          ğŸ“¦ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
          {% if branch %}
            - {{ branch.name }}
          {% elif branches %}
            - ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹
          {% endif %}
        </h1>
      </div>

      <!-- ğŸ”½ Ø§Ù„ÙÙ„Ø§ØªØ± -->
      <form method="get" id="filterForm" class="filters">
        <div class="row g-3 align-items-end">

          {% if branches %}
          <div class="col-md-3">
            <label class="form-label">Ø§Ù„ÙØ±Ø¹:</label>
            <select name="branch" class="form-select" onchange="this.form.submit()">
              <option value="all" {% if not selected_branch %}selected{% endif %}>-- ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹ --</option>
              {% for b in branches %}
                <option value="{{ b.id }}" {% if selected_branch == b.id %}selected{% endif %}>
                  {{ b.name }}
                </option>
              {% endfor %}
            </select>
          </div>
          {% endif %}

          <div class="col-md-3">
            <label class="form-label">Ø§Ù„Ù‚Ø³Ù…:</label>
            <select name="category" class="form-select" onchange="this.form.submit()">
              <option value="">-- ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… --</option>
              {% for c in categories %}
                <option value="{{ c.id }}" {% if selected_category == c.id %}selected{% endif %}>
                  {{ c.name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label">Ø¨Ø­Ø«:</label>
            <input type="text" class="form-control" name="q" value="{{ query|default:'' }}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" id="searchInput" autofocus>
          </div>

          <div class="col-md-3">
            <button type="submit" class="btn btn-success custom-btn">Ø¹Ø±Ø¶</button>
          </div>
        </div>
      </form>
    </div>

    <!-- âœ… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†ÙØ³ Ø³ØªØ§ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
    <div class="table-wrapper">
      <table class="styled-table">
        <thead>
  <tr>
    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
    <th>Ø§Ù„Ù‚Ø³Ù…</th>
    {% if branches %}<th>Ø§Ù„ÙØ±Ø¹</th>{% endif %}
    <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø©</th>
    <th>ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ©</th> <!-- âœ… Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
  </tr>
</thead>
<tbody>
  {% for inv in inventories %}
  <tr>
    <td>{{ inv.product.name }}</td>
    <td>{{ inv.product.category.name }}</td>
    {% if branches %}<td>{{ inv.branch.name }}</td>{% endif %}
    <!-- <td>{{ inv.quantity }}</td> -->
    <td>
      {% if inv.product.unit == 'kg' %}
        {% if inv.quantity == 0 %}
          <span class="badge bg-danger">ØºÙŠØ± Ù…ØªØ§Ø­</span>
        {% elif inv.quantity == 999 %}
          <span class="badge bg-success">Ù…ØªØ§Ø­</span>
        {% else %}
          <span class="badge bg-warning text-dark">Ø¨Ø§Ù„Ø­Ø¬Ø²</span>
        {% endif %}
      {% else %}
        {{ inv.quantity }}
      {% endif %}
    </td>
    <!-- âœ… Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
    <td>
      <div class="d-flex justify-content-center align-items-center gap-1">
        {% if inv.product.unit == 'kg' %}
        <select name="new_quantity"
                class="form-select form-select-sm text-center fw-bold"
                style="width: 120px;">
          <option value="999" {% if inv.quantity == 999 %}selected{% endif %}>ğŸŸ¢ Ù…ØªØ§Ø­</option>
          <option value="998" {% if inv.quantity != 0 and inv.quantity != 998 %}selected{% endif %}>ğŸŸ¡ Ø¨Ø§Ù„Ø­Ø¬Ø²</option>
          <option value="0" {% if inv.quantity == 0 %}selected{% endif %}>ğŸ”´ ØºÙŠØ± Ù…ØªØ§Ø­</option>
        </select>
      {% else %}
        <input type="number"
               name="new_quantity"
               min="0"
               step="0.01"
               class="form-control form-control-sm text-center fw-bold"
               style="width: 80px;"
               placeholder="ÙƒÙ…ÙŠØ©">
      {% endif %}
             <button type="button" class="btn btn-warning btn-sm update-btn" data-product="{{ inv.product.id }}">âœï¸</button>
    </td>
  </tr>
  {% empty %}
  <tr>
    <td colspan="{% if branches %}5{% else %}4{% endif %}" class="text-center">âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.</td>
  </tr>
  {% endfor %}
</tbody>

      </table>
    </div>
</div>
<script>
// Ù„Ù…Ø§ Ø§Ù„ØµÙØ­Ø© ØªØ®Ù„Øµ ØªØ­Ù…ÙŠÙ„
window.addEventListener('load', function() {
  const input = document.getElementById('searchInput');
  if (input) {
    // Ù„Ù…Ø§ Ø§Ù„Ø¹Ù†ØµØ± ÙŠØ§Ø®Ø¯ ÙÙˆÙƒØ³ ÙŠØ­Ø¯Ø¯ Ø§Ù„Ù†Øµ ÙƒÙ„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    input.focus();
    input.select();
    // ÙƒÙ…Ø§Ù† Ù„Ùˆ Ø±Ø¬Ø¹Øª ÙÙˆÙƒØ³ Ø¹Ù„ÙŠÙ‡ Ø¨Ø¹Ø¯ÙŠÙ† ÙŠØ­Ø¯Ø¯ Ø§Ù„Ù†Øµ Ø¨Ø±Ø¶Ù‡
    input.addEventListener('focus', () => input.select());
  }
});
document.addEventListener("DOMContentLoaded", function() {

  // ğŸŸ¢ Ø¯Ø§Ù„Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ« (ØªØ³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø²Ø± Ø£Ùˆ Enter)
  function updateQuantity(row, productId, newQty, input) {
    const formData = new FormData();
    formData.append("product_id", productId);
    formData.append("new_quantity", newQty);

    fetch("{% url 'update_inventory_quantity' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
        "X-Requested-With": "XMLHttpRequest"
      },
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // âœ… ÙˆÙ…ÙŠØ¶ Ø£Ø®Ø¶Ø± Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        row.style.transition = "background 0.4s";
        row.style.backgroundColor = "#d4edda";
        setTimeout(() => row.style.backgroundColor = "", 800);

        // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        const allTds = row.querySelectorAll("td");
        const qtyCell = allTds.length === 5 ? allTds[3] : allTds[2];
        if (qtyCell) qtyCell.textContent = data.new_qty;

        // âœ… ÙØ¶ÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        input.value = "";
      } else {
        alert(data.message);
      }
    })
    .catch(err => {
      console.error(err);
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….");
    });
  }

  // âœï¸ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«
  document.querySelectorAll(".update-btn").forEach(btn => {
    btn.addEventListener("click", function() {
      const row = this.closest("tr");
      // const input = row.querySelector("input[name='new_quantity']");
      // const newQty = input.value.trim();
      const input = row.querySelector("input[name='new_quantity'], select[name='new_quantity']");
      const newQty = input.value.trim();
      const productId = this.dataset.product;

      if (!newQty) {
        alert("âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.");
        return;
      }

      updateQuantity(row, productId, newQty, input);
    });
  });

  // âŒ¨ï¸ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter Ø¯Ø§Ø®Ù„ input
  document.querySelectorAll("input[name='new_quantity']").forEach(input => {

    // âœ… ÙŠØ­Ø¯Ø¯ Ø§Ù„Ù†Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² (focus)
    input.addEventListener("focus", function() {
      this.select();
    });

    // âœ… ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ù„Ù€ Enter
    input.addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        e.preventDefault(); // ÙŠÙ…Ù†Ø¹ reload Ø£Ùˆ submit
        const row = this.closest("tr");
        const btn = row.querySelector(".update-btn");
        const productId = btn.dataset.product;
        const newQty = this.value.trim();

        if (!newQty) {
          alert("âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.");
          return;
        }

        updateQuantity(row, productId, newQty, this);
      }
    });
  });

});
</script>
<style>
  html, body {
    height: 100%;
    margin: 0;
    overflow: hidden; /* ÙŠÙ…Ù†Ø¹ Scroll Ø®Ø§Ø±Ø¬ÙŠ */
  }

  .inventory-dashboard {
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }

  .header-fixed {
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 20;
    padding-bottom: 10px;
    border-bottom: 2px solid #ddd;
  }

  .filters { margin-bottom: 10px; }

  .table-wrapper {
    flex: 1 1 auto;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 8px;
  }

  .styled-table {
    width: 70%;              /* Ù†ÙØ³ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª */
    margin: 20px auto;       /* ÙŠØ®Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Ø§Ù„Ù†Øµ */
    border-collapse: collapse;
    font-size: 15px;
  }

  .styled-table th, .styled-table td {
    padding: 6px 8px;        /* Ù†ÙØ³ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª */
    text-align: center;
    border: 1px solid #eee;
  }

  .styled-table th {
    position: sticky;
    top: 0;
    background: #000;
    color: #fff;
    font-weight: bold;
    z-index: 5;
    font-size: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  .styled-table tbody tr:hover {
    background: #f8d7da; /* Ø£Ø­Ù…Ø± ÙØ§ØªØ­ */
    transition: background 0.2s ease-in-out;
    cursor: pointer;
  }

  h1.m-0 {
    font-size: 1.5rem !important;
    font-weight: bold;
    margin: 0;
  }
  .custom-btn {
      padding: 8px 25px;
      font-size: 15px;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.3s ease-in-out;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      background: linear-gradient(135deg, #28a745, #34ce57); /* Ø¬Ø±Ø§Ø¯ÙŠØ§Ù†Øª Ø§ÙØªØ±Ø§Ø¶ÙŠ */
      border: none;
    }

    .custom-btn:hover {
      background: linear-gradient(135deg, #218838, #28a745); /* Ø¬Ø±Ø§Ø¯ÙŠØ§Ù†Øª Ø£ØºÙ…Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù‡ÙˆÙØ± */
      color: #fff;
      transform: translateY(-2px);   /* ÙŠØ·Ù„Ø¹ Ù„ÙÙˆÙ‚ */
      box-shadow: 0 6px 12px rgba(0,0,0,0.2); /* Ø¸Ù„ Ø£Ù‚ÙˆÙ‰ */
    }

    .custom-btn:active {
      transform: translateY(0); /* ÙŠØ±Ø¬Ø¹ Ù…ÙƒØ§Ù†Ù‡ Ù„Ù…Ø§ ÙŠØªØ¯Ø§Ø³ */
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    form.d-flex input[type="number"] {
  max-width: 80px;
}
form.d-flex button {
  min-width: 40px;
}

</style>
{% endblock %}
