{% extends "orders/base.html" %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

<h2>
  📦 المخزون
  {% if branch %}
    - {{ branch.name }}
  {% elif branches %}
    - كل الفروع
  {% endif %}
</h2>

<!-- 🔽 فلترة الأقسام + البحث + الفروع -->
<form method="get" class="mb-3" id="filterForm">
  <div style="display:flex; gap:15px; align-items:flex-end; flex-wrap:wrap;">

    <!-- ✅ فلتر الفروع (للأدمن والكول سنتر فقط) -->
    {% if branches %}
    <div class="form-group">
      <label class="form-label">الفرع:</label>
      <select name="branch" class="form-control" onchange="this.form.submit()">
        <option value="all" {% if not selected_branch %}selected{% endif %}>-- كل الفروع --</option>
        {% for b in branches %}
          <option value="{{ b.id }}" {% if selected_branch == b.id %}selected{% endif %}>
            {{ b.name }}
          </option>
        {% endfor %}
      </select>
    </div>
    {% endif %}

    <!-- فلتر القسم -->
    <div class="form-group">
      <label class="form-label">القسم:</label>
      <select name="category" class="form-control" onchange="this.form.submit()">
        <option value="">-- كل الأقسام --</option>
        {% for c in categories %}
          <option value="{{ c.id }}" {% if selected_category == c.id %}selected{% endif %}>
            {{ c.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- البحث -->
    <div class="form-group">
      <label class="form-label">بحث:</label>
      <input type="text" class="form-control" name="q" value="{{ query|default:'' }}" placeholder="اسم المنتج">
    </div>

    <div>
      <button type="submit" class="btn btn-primary">عرض</button>
    </div>
  </div>
</form>

<!-- جدول المخزون -->
<div class="table-responsive mt-4">
  <table class="table table-bordered table-striped">
    <thead class="table-dark">
      <tr>
        <th>المنتج</th>
        <th>القسم</th>
        {% if branches %}<th>الفرع</th>{% endif %}
        <th>الكمية المتوفرة</th>
      </tr>
    </thead>
    <tbody>
      {% for inv in inventories %}
      <tr>
        <td>{{ inv.product.name }}</td>
        <td>{{ inv.product.category.name }}</td>
        {% if branches %}<td>{{ inv.branch.name }}</td>{% endif %}
        <td>{{ inv.quantity }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="{% if branches %}4{% else %}3{% endif %}" class="text-center">❌ لا توجد منتجات مطابقة.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  // ✅ لما المستخدم يضغط Enter فى البحث → الفورم يتبعت
  document.querySelector("input[name='q']").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
      e.preventDefault();
      document.getElementById("filterForm").submit();
    }
  });
</script>

{% endblock %}
