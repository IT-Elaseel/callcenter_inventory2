{% extends "orders/base.html" %}
{% block content %}
<div class="container mt-3">
  <h2 class="text-center mb-4 fw-bold">🛍️ إنشاء طلبية جديدة</h2>

  <!-- <form method="post" class="text-center mb-3">
    {% csrf_token %}
    <button type="submit" name="load_standard" class="btn btn-outline-primary btn-lg px-4">
      📋 تحميل الطلبية القياسية
    </button>
  </form> -->
  <form method="post" class="text-center mb-3">
    {% csrf_token %}
    <label class="fw-bold">📋 اختر استمبا لتحميلها:</label>
    <select name="stamp_name" class="form-select d-inline-block w-auto mx-2">
      {% for s in all_stamps %}
        <option value="{{ s }}">{{ s }}</option>
      {% endfor %}
    </select>
    <button type="submit" name="load_standard" class="btn btn-outline-primary btn-lg px-4">
      تحميل الطلبية القياسية
    </button>
  </form>

  <!-- 🔹 الأقسام الرئيسية -->
  <div class="card shadow-sm mb-3">
    <div class="card-body text-center">
      <h5 class="fw-bold mb-3">📂 اختر القسم الرئيسي</h5>
      <div id="categories" class="d-flex flex-wrap justify-content-center gap-2">
        {% for c in categories %}
          <button type="button" class="btn btn-lg btn-category"
                  onclick="showSubcategories('{{ c.id }}', '{{ c.name }}')">
            {{ c.name }}
          </button>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- 🔹 الأقسام الفرعية -->
  <div id="subcategoriesSection" class="card shadow-sm mb-3 d-none">
    <div class="card-body text-center">
      <h5 class="fw-bold mb-3">📁 اختر القسم الفرعي من <span id="mainCategoryName" class="text-primary"></span></h5>
      <div id="subcategories" class="d-flex flex-wrap justify-content-center gap-2">
        {% for s in second_categories %}
          <button type="button"
            class="btn btn-lg btn-secondary-category d-none"
            data-main="{{ s.main_category.id|stringformat:'s' }}"
            onclick="showProducts('{{ s.id }}', '{{ s.name }}')">
            {{ s.name }}
          </button>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- 🔹 المنتجات -->
  <div id="productsSection" class="full-width-section d-none">
    <div class="inner-products text-center py-3">
      <h5 class="fw-bold mb-3">
        🛒 منتجات قسم <span id="selectedCategoryName" class="text-primary"></span>
      </h5>

      <div id="products" class="products-grid">
        {% for p in products %}
          <button type="button"
                  class="btn btn-product d-none"
                  data-category="{{ p.category_id }}"
                  data-subcategory="{{ p.second_category_id }}"
                  data-product-id="{{ p.id }}"
                  data-product-name="{{ p.name }}"
                  data-unit="{{ p.get_unit_display }}"
                  onclick="selectProduct(this)">
            {{ p.name }}
          </button>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- 🔹 إدخال الكمية -->
  <div id="quantitySection" class="card shadow-sm mb-4 d-none">
    <div class="card-body text-center">
      <h5 class="fw-bold mb-3">
        📦 المنتج المحدد: <span id="selectedProductName" class="text-success"></span>
      </h5>
      <form method="post" id="addForm"
            class="d-flex flex-column flex-sm-row justify-content-center align-items-center gap-2">
        {% csrf_token %}
        <input type="hidden" name="product" id="productInput">
        <input type="number" name="quantity" id="quantityInput"
               class="form-control text-center fw-bold"
               style="max-width:150px; font-size:1.2rem;"
               min="0.01" step="0.01" required placeholder="الكمية" autofocus>
        <span id="unitLabel" class="fw-bold text-primary" style="font-size:1.1rem;"></span>
        <button type="submit" name="add_item" class="btn btn-success btn-lg px-4">
          ➕ إضافة
        </button>
      </form>
    </div>
  </div>

  <!-- 🔹 الطلبية الحالية -->
  <h4 class="mb-3 text-center fw-bold">
    📋 الطلبية الحالية (رقم:
    <span class="badge bg-primary">{{ order_number }}</span>)
  </h4>

  {% if requests_today %}
  <form method="post" id="deleteForm">
    {% csrf_token %}
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <button type="submit" name="delete_selected" class="btn btn-danger btn-sm">
          🗑️ حذف المحدد
        </button>
        <button type="submit" name="delete_all" class="btn btn-outline-danger btn-sm">
          ❌ حذف الكل
        </button>
      </div>
      <div>
        <small class="text-muted">حدد العناصر التي تريد حذفها</small>
      </div>
    </div>

    <div class="table-responsive shadow-sm">
      <table class="table table-striped table-hover align-middle text-center">
        <thead class="table-dark">
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>المنتج</th>
            <th>الكمية</th>
            <th>الوحدة</th>
            <th>الوقت</th>
          </tr>
        </thead>
        <tbody>
          {% for r in requests_today %}
            <tr>
              <td><input type="checkbox" name="selected_items" value="{{ r.id }}"></td>
              <td class="fw-bold">{{ r.product.name }}</td>
              <td>
                <div class="d-flex justify-content-center align-items-center gap-2">
                  <form method="post" class="d-flex gap-2 m-0 p-0">
                    {% csrf_token %}
                    <input type="hidden" name="request_id" value="{{ r.id }}">
                    <input type="number"
                           name="new_quantity"
                           value="{% if r.product.get_unit_display == 'كيلو' %}{{ r.quantity|stringformat:'.2f' }}{% else %}{{ r.quantity|floatformat:0 }}{% endif %}"
                           {% if r.product.get_unit_display == 'كيلو' %}min="0.01" step="0.01"{% else %}min="1" step="1"{% endif %}
                           class="form-control form-control-sm text-center" style="width: 80px;">
                    <button type="submit" name="update_item" class="btn btn-warning btn-sm px-3">✏️</button>
                  </form>
                </div>
              </td>
              <td><span class="badge bg-secondary">{{ r.product.get_unit_display }}</span></td>
              <td>{{ r.created_at|date:"H:i:s" }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="5" class="text-muted">🚫 لا يوجد منتجات</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>

  <form method="post" class="mt-3 text-center">
    {% csrf_token %}
    <button type="submit" name="confirm_order" class="btn btn-primary btn-lg px-5">
      ✅ تأكيد الطلبية
    </button>
  </form>
  {% else %}
  <div class="alert alert-light text-center text-muted">🚫 لا يوجد منتجات حالياً</div>
  {% endif %}
</div>

<!-- 🔸 سكريبت التحكم -->
<script>
// 🔹 عرض الأقسام الفرعية بعد اختيار القسم الرئيسي
function showSubcategories(categoryId, categoryName) {
  document.getElementById("productsSection").classList.add("d-none");
  document.getElementById("quantitySection").classList.add("d-none");
  document.getElementById("subcategoriesSection").classList.remove("d-none");
  document.getElementById("mainCategoryName").textContent = categoryName;

  const allSubs = document.querySelectorAll(".btn-secondary-category");
  allSubs.forEach(btn => {
    btn.classList.toggle("d-none", btn.dataset.main !== String(categoryId));
  });

  localStorage.setItem("selectedMainCategoryId", categoryId);
  localStorage.setItem("selectedMainCategoryName", categoryName);
}

// 🔹 عرض المنتجات بعد اختيار القسم الفرعي
function showProducts(subId, subName) {
  document.getElementById("subcategoriesSection").classList.add("d-none");
  document.getElementById("productsSection").classList.remove("d-none");
  document.getElementById("selectedCategoryName").textContent = subName;

  const allBtns = document.querySelectorAll(".btn-product");
  allBtns.forEach(btn => {
    btn.classList.toggle("d-none", btn.dataset.subcategory !== subId);
  });

  localStorage.setItem("selectedSubCategoryId", subId);
  localStorage.setItem("selectedSubCategoryName", subName);
}

// 🔹 تحديد المنتج
function selectProduct(btn) {
  const productId = btn.dataset.productId;
  const productName = btn.dataset.productName;
  const unit = btn.dataset.unit;

  const quantityInput = document.getElementById("quantityInput");

  // 🔒 أولاً: إعادة تعيين step/min افتراضيًا إلى القيم العشرية
  quantityInput.min = "0.01";
  quantityInput.step = "0.01";

  // 🟢 ضبط min و step حسب نوع الوحدة
  if (unit === "كيلو" || unit.toLowerCase().includes("kg")) {
    quantityInput.min = "0.01";
    quantityInput.step = "0.01";
  } else {
    quantityInput.min = "1";
    quantityInput.step = "1";
  }

  document.getElementById("productInput").value = productId;
  document.getElementById("selectedProductName").textContent = productName;
  document.getElementById("unitLabel").textContent = unit;
  document.getElementById("quantitySection").classList.remove("d-none");

  quantityInput.value = "";
  quantityInput.focus();
}
// 🔹 تحديد الكل / إلغاء التحديد
document.addEventListener("DOMContentLoaded", function() {
  const selectAll = document.getElementById("selectAll");
  if (selectAll) {
    selectAll.addEventListener("change", function() {
      const checkboxes = document.querySelectorAll("input[name='selected_items']");
      checkboxes.forEach(cb => cb.checked = selectAll.checked);
    });
  }

  // 🧹 مسح التخزين بعد تأكيد الطلبية
  const confirmBtn = document.querySelector("button[name='confirm_order']");
  if (confirmBtn) {
    confirmBtn.addEventListener("click", function() {
      localStorage.clear();
    });
  }
});
// 🟢 استرجاع آخر مسار بعد تحميل الصفحة
document.addEventListener("DOMContentLoaded", function() {
  const mainId = localStorage.getItem("selectedMainCategoryId");
  const mainName = localStorage.getItem("selectedMainCategoryName");
  const subId = localStorage.getItem("selectedSubCategoryId");
  const subName = localStorage.getItem("selectedSubCategoryName");

  // لو فيه قسم رئيسي محفوظ
  if (mainId && mainName) {
    showSubcategories(mainId, mainName);

    // لو فيه كمان قسم فرعي محفوظ
    if (subId && subName) {
      setTimeout(() => {
        showProducts(subId, subName);
      }, 200);
    }
  }
});
</script>

<!-- 🎨 تنسيق الشبكة والأزرار -->
<style>
.btn-category {
  background-color: #007bff;
  color: white;
  font-size: 1.2rem;
  font-weight: 600;
  border-radius: 10px;
  min-width: 110px;
  padding: 12px 18px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  transition: 0.2s;
}
.btn-category:hover { background-color: #0056b3; transform: scale(1.05); }

.btn-secondary-category {
  background-color: #6c757d;
  color: #fff;
  font-size: 1.1rem;
  font-weight: 600;
  border-radius: 10px;
  min-width: 110px;
  padding: 12px 18px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  transition: 0.2s;
}
.btn-secondary-category:hover { background-color: #5a6268; transform: scale(1.05); }

.products-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  justify-items: stretch;
}

.btn-product {
  background-color: #28a745;
  color: #fff;
  font-size: 1.5rem;
  font-weight: 700;
  border-radius: 12px;
  height: 90px;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  transition: 0.15s;
}
.btn-product:hover { background-color: #1e7e34; transform: scale(1.05); }

@media (max-width: 992px) { .products-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 600px) {
  .products-grid { grid-template-columns: 1fr; }
  .btn-product { font-size: 1.7rem; height: 100px; }
}

.full-width-section {
  position: relative;
  left: 50%;
  right: 50%;
  margin-left: -50vw;
  margin-right: -50vw;
  width: 100vw;
  background-color: #fff;
  padding: 0 10px;
  box-sizing: border-box;
}
.inner-products { max-width: 1200px; margin: 0 auto; }
</style>

{% endblock %}
