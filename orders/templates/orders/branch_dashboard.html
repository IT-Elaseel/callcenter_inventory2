{% extends "orders/base.html" %}
{% block title %}🏬 لوحة الفرع{% endblock %}

{% block content %}
<div class="inventory-dashboard">

  <!-- ✅ الهيدر -->
  <div class="header-fixed">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="m-0" style="font-size: 1.5rem;">
        🏬 لوحة الفرع
        {% if branch %}- {{ branch.name }}{% endif %}
      </h1>
    </div>

    {% if is_admin %}
      <form method="get" class="filters row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">اختار الفرع:</label>
          <select name="branch" class="form-select" onchange="this.form.submit()">
            <option value="">-- اختار فرع --</option>
            {% for b in branches %}
              <option value="{{ b.id }}" {% if b.id|stringformat:'s' == selected_branch_id %}selected{% endif %}>
                {{ b.name }}
              </option>
            {% endfor %}
          </select>
        </div>
      </form>
      {% if branch %}
      <p>
        📥 تصدير الحجوزات لــ {{ branch.name }}
        <a href="{% url 'export_reservations_excel' branch.id %}" class="btn btn-success btn-sm">Excel</a>
      </p>
      {% endif %}
    {% endif %}
  </div>

  <!-- ✅ الجدول -->
  <div class="table-wrapper">
    <table class="styled-table">
      <thead>
          <tr>
            <th>رقم الحجز</th>
            <th>العميل</th>
            <th>رقم الهاتف</th>
            <th>المنتج</th>
            <th>الكمية</th>
            <th>الحالة</th>
            <th>تاريخ الإنشاء</th>
            <th>تاريخ القرار</th>
            <th>آخر إجراء للفرع</th>
            <th>تم الحجز بواسطة</th>
            <th>الإجراء</th>
          </tr>
      </thead>
      <tbody>
        {% for res in reservations %}
          {% if res.status == "pending" %}
          <tr>
            <td>{{ res.id }}</td>
            <td>{{ res.customer.name }}</td>
            <td>{{ res.customer.phone }}</td>
            <td>{{ res.product.name }}</td>
            <td>{{ res.quantity }}</td>
            <td>{{ res.get_status_display }}</td>
            <td>{{ res.created_at|date:"Y-m-d H:i:s" }}</td>
            <td>{{ res.decision_at|date:"Y-m-d H:i:s" }}</td>
            <td>
              {% if res.branch_last_modified_at %}
                {{ res.branch_last_modified_at|date:"Y-m-d H:i:s" }}
              {% else %}-{% endif %}
            </td>
            <td>
              {% if res.reserved_by %}
                {{ res.reserved_by.username }}
              {% else %}-{% endif %}
            </td>
            <td>
              <a href="{% url 'update_reservation_status' res.id 'confirmed' %}"
                 class="custom-btn btn-success btn-sm">✅ تأكيد</a>

              <a href="{% url 'update_reservation_status' res.id 'cancelled' %}"
                 class="custom-btn btn-danger btn-sm">❌ إلغاء</a>
            </td>
          </tr>
          {% endif %}
        {% empty %}
          <tr><td colspan="11" class="text-center">🚫 لا توجد حجوزات معلقة</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<style>
  html, body { height: 100%; margin: 0; overflow: hidden; }

  .inventory-dashboard {
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }

  .header-fixed {
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 20;
    padding-bottom: 10px;
    border-bottom: 2px solid #ddd;
  }

  .filters { margin-bottom: 10px; }

  .table-wrapper {
    flex: 1 1 auto;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 8px;
  }

  .styled-table {
    width: 70%;
    margin: 20px auto;
    border-collapse: collapse;
    font-size: 15px;
  }

  .styled-table th, .styled-table td {
    padding: 6px 8px;
    text-align: center;
    border: 1px solid #eee;
  }

  .styled-table th {
    position: sticky;
    top: 0;
    background: #000;
    color: #fff;
    font-weight: bold;
    z-index: 5;
    font-size: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  .styled-table tbody tr:hover {
    background: #f8d7da;
    transition: background 0.2s ease-in-out;
    cursor: pointer;
  }

  h1.m-0 {
    font-size: 1.5rem !important;
    font-weight: bold;
    margin: 0;
  }
  .custom-btn {
  padding: 5px 15px;         /* أصغر من 8px 25px */
  font-size: 13px;           /* خط أصغر */
  font-weight: 600;
  border-radius: 6px;        /* دوران أقل */
  transition: all 0.3s ease-in-out;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: none;
  color: #fff;
  display: inline-block;
  text-decoration: none;
}

/* ✅ زر التأكيد */
.btn-success.custom-btn {
  background: linear-gradient(135deg, #28a745, #34ce57);
}
.btn-success.custom-btn:hover {
  background: linear-gradient(135deg, #218838, #28a745);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

/* ❌ زر الإلغاء */
.btn-danger.custom-btn {
  background: linear-gradient(135deg, #dc3545, #e4606d);
}
.btn-danger.custom-btn:hover {
  background: linear-gradient(135deg, #c82333, #dc3545);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.custom-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
</style>
{% endblock %}
