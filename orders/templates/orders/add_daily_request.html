{% extends "orders/base.html" %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4 text-center">📝 المطلوب اليومي</h2>

  <!-- 🟢 فورم إضافة منتج -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
    <form method="post" class="row g-3 align-items-end">
  {% csrf_token %}

  <!-- اختيار القسم -->
  <div class="col-md-4">
    <label for="categorySelect" class="form-label fw-bold">القسم</label>
    <select name="category" id="categorySelect" class="form-select" required onchange="filterProducts()">
      <option value="">-- اختر القسم --</option>
      {% for c in categories %}
        <option value="{{ c.id }}" {% if selected_category == c.id|stringformat:"s" %}selected{% endif %}>
          {{ c.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- اختيار المنتج -->
  <div class="col-md-4">
    <label for="productSelect" class="form-label fw-bold">المنتج</label>
    <select name="product" id="productSelect" class="form-select" required onchange="updateUnitLabel()">
      <option value="">-- اختر المنتج --</option>
      {% for p in products %}
        <option value="{{ p.id }}"
                data-unit="{{ p.get_unit_display }}"
                data-category="{{ p.category_id }}">
          {{ p.name }}
        </option>
      {% endfor %}
    </select>
  </div>


  <!-- الكمية + الوحدة -->
  <div class="col-md-3">
    <label class="form-label fw-bold">الكمية</label>
    <div class="input-group">
      <input type="number" name="quantity" min="1" required placeholder="الكمية" class="form-control">
      <span id="unitLabel" class="input-group-text bg-light fw-bold text-dark d-none"></span>
    </div>
  </div>

  <!-- زرار الإضافة -->
  <div class="col-md-1 text-end">
    <button type="submit" name="add_item" class="btn btn-success w-100">➕</button>
  </div>
</form>
    </div>
  </div>

  <!-- 🟣 الطلبية الحالية -->
  <h3 class="mb-3">📋 الطلبية الحالية (رقم: <span class="badge bg-primary">{{ order_number }}</span>)</h3>

  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle text-center">
      <thead class="table-dark">
        <tr>
          <th>المنتج</th>
          <th>الكمية</th>
          <th>الوحدة</th>
          <th>الوقت</th>
        </tr>
      </thead>
      <tbody>
        {% for r in requests_today %}
          <tr>
            <td>{{ r.product.name }}</td>
            <td><span class="badge bg-info text-dark">{{ r.quantity }}</span></td>
            <td><span class="badge bg-secondary">{{ r.product.get_unit_display }}</span></td>
            <td>{{ r.created_at|date:"H:i:s" }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="4" class="text-muted">🚫 لا يوجد منتجات</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- 🟡 زر تأكيد الطلبية -->
  {% if requests_today %}
    <form method="post" class="mt-3">
      {% csrf_token %}
      <button type="submit" name="confirm_order" class="btn btn-primary btn-lg">
        ✅ تأكيد الطلبية
      </button>
    </form>
  {% endif %}

</div>

<!-- 🔵 سكريبت لتحديث الوحدة -->
<script>
  function updateUnitLabel() {
    const select = document.getElementById("productSelect");
    const unitLabel = document.getElementById("unitLabel");
    const selectedOption = select.options[select.selectedIndex];
    const unit = selectedOption.getAttribute("data-unit");

    if (unit) {
      unitLabel.textContent = unit;
      unitLabel.classList.remove("d-none");
    } else {
      unitLabel.textContent = "";
      unitLabel.classList.add("d-none");
    }
  }
</script>
<script>
function filterProducts() {
  const categorySelect = document.getElementById("categorySelect");
  const productSelect = document.getElementById("productSelect");
  const selectedCategory = categorySelect.value;

  // ارجع كل المنتجات للـ default
  for (let i = 0; i < productSelect.options.length; i++) {
    const option = productSelect.options[i];
    const cat = option.getAttribute("data-category");
    if (!selectedCategory || option.value === "") {
      option.style.display = ""; // دايمًا خليه ظاهر
    } else {
      option.style.display = (cat === selectedCategory) ? "" : "none";
    }
  }

  // رجّع المؤشر لأول اختيار
  productSelect.value = "";
  updateUnitLabel();
}
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  filterProducts();  // فلتر المنتجات بناءً على القسم المتعلم تلقائيًا
});
</script>
{% endblock %}
