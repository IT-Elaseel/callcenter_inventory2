{% extends "orders/base.html" %}
{% block title %}Ù„ÙˆØ­Ø© Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ±{% endblock %}

{% block content %}
<div class="cc-dashboard">

    <!-- âœ… Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ø¨Øª ÙƒÙ„Ù‡ -->
    <div class="header-fixed">
        <h1 class="page-title">â˜ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ±</h1>

        <!-- Search + Category Filter + Reservations Button -->
        <form method="get" class="cc-filters">
            <div class="input-wrapper">
                <input type="text" name="q" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." value="{{ query|default:'' }}" autofocus>
            </div>
            <div class="select-wrapper">
                <select name="category" onchange="this.form.submit()">
                    <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
                    {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if selected_category == cat.id %}selected{% endif %}>
                            {{ cat.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary">ğŸ” Ø¨Ø­Ø«</button>
            <a href="{% url 'reservations_list' %}" class="btn btn-secondary ml-auto">
                ğŸ“‹ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
            </a>
        </form>

        <h2 class="section-title">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>

        {% if conflict_phone %}
        <div class="alert warning">
            âš ï¸ Ø§Ù„Ø±Ù‚Ù… {{ conflict_phone }} Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ø³Ù… Ù…Ø®ØªÙ„Ù.
            {% if conflict_name %} (Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯: {{ conflict_name }}){% endif %}
            <form method="post" action="{% url 'resolve_conflict' %}" class="conflict-form">
                {% csrf_token %}
                <input type="hidden" name="phone" value="{{ conflict_phone }}">
                <input type="hidden" name="name" value="{{ conflict_name }}">
                <input type="hidden" name="product_id" value="{{ conflict_product_id }}">
                <input type="hidden" name="branch_id" value="{{ conflict_branch_id }}">
                <input type="hidden" name="delivery_type" value="{{ conflict_delivery_type }}">
                <input type="hidden" name="quantity" value="{{ conflict_qty }}">
                <button type="submit" name="action" value="use_old" class="btn btn-warning">
                    âœ… Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…
                </button>
                <button type="submit" name="action" value="new_customer" class="btn btn-success">
                    â• Ø£Ù†Ø´Ø¦ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ø¨Ù†ÙØ³ Ø§Ù„Ø±Ù‚Ù…
                </button>
            </form>
        </div>
        {% endif %}
    </div>

    <!-- âœ… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù‡Ùˆ Ø§Ù„Ù„ÙŠ Scroll -->
    <div class="table-wrapper">
        <table class="styled-table">
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                    <th>Ø§Ù„Ù‚Ø³Ù…</th>
                    <th>Ø§Ù„ÙØ±ÙˆØ¹ ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª</th>
                    <th>Ø§Ù„Ø­Ø¬Ø²</th>
                </tr>
            </thead>
            <tbody>
            {% regroup inventories by product as product_list %}
            {% for group in product_list %}
                <tr>
                    <td>{{ group.grouper.name }}</td>
                    <td>{{ group.grouper.category.name }}</td>
                    <td>
                        {% for inv in group.list %}
                            {% if inv.quantity > 0 %}
                                ğŸ¬ {{ inv.branch.name }}: {{ inv.quantity }}<br>
                            {% endif %}
                        {% endfor %}
                    </td>
                    <td>
                        {% for inv in group.list %}
                            {% if inv.quantity > 0 %}
                                <form method="post" action="{% url 'callcenter_dashboard' %}" class="reserve-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="product_id" value="{{ inv.product.id }}">
                                    <input type="hidden" name="branch_id" value="{{ inv.branch.id }}">
                                    <input type="text" name="customer_name" placeholder="ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" required>
                                    <input type="text" name="customer_phone" placeholder="ğŸ“ Ù…ÙˆØ¨Ø§ÙŠÙ„" inputmode="numeric" maxlength="11" pattern="\d{11}"
                                        oninput="this.value=this.value.replace(/\D/g,'').slice(0,11)" >
                                    <select name="delivery_type" required>
                                        <option value="pickup">ğŸš¶â€â™‚ï¸ Ø§Ø³ØªÙ„Ø§Ù…</option>
                                        <option value="delivery">ğŸšš ØªÙˆØµÙŠÙ„</option>
                                    </select>

                                    <!-- âœ… Ø®Ø§Ù†Ø© Ø§Ù„ÙƒÙ…ÙŠØ© Ù…Ø¹ Error state -->
                                    <input type="number" name="quantity" value="1" min="1"
                                        class="qty {% if quantity_error and quantity_error.product_id == inv.product.id and quantity_error.branch_id == inv.branch.id %}error{% endif %}"onfocus="this.select()">
                                    <span>{{ inv.product.get_unit_display }}</span>

                                    {% if quantity_error and quantity_error.product_id == inv.product.id and quantity_error.branch_id == inv.branch.id %}
                                        <div class="error-msg">{{ quantity_error.message }}</div>
                                    {% endif %}

                                    <!-- âœ… Ø²Ø±Ø§Ø± Ø¨Ù„ÙˆÙ† Ø«Ø§Ø¨Øª Ø­Ø³Ø¨ ID Ø§Ù„ÙØ±Ø¹ -->
                                    <button type="submit" class="btn branch-btn" data-branch-id="{{ inv.branch.id }}">
                                        Ø§Ø­Ø¬Ø² Ù…Ù† {{ inv.branch.name }}
                                    </button>
                                </form>
                            {% endif %}
                        {% endfor %}
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
    html, body { height: 100%; margin: 0; }
    .cc-dashboard { display: flex; flex-direction: column; height: 100vh; }
    .header-fixed { position: sticky; top: 0; background: #fff; z-index: 20; padding-bottom: 10px; }
    .table-wrapper { flex: 1 1 auto; overflow-y: auto; border:1px solid #ddd; border-radius:8px; }
    .styled-table { width:100%; border-collapse:collapse; font-size:15px; }
    .styled-table th, .styled-table td { padding:12px; text-align:center; border:1px solid #eee; }
    .styled-table th { position: sticky; top: 0; background:#f8f9fa; z-index: 5; font-size:16px; box-shadow:0 2px 4px rgba(0,0,0,0.05); }
    body { font-family: "Cairo", "Segoe UI", Tahoma, sans-serif; font-size: 16px; color: #333; }
    .page-title { font-size:28px; margin-bottom:25px; color:#222; font-weight:700; }
    .section-title { font-size:20px; margin:20px 0; color:#444; font-weight:600; }
    .cc-filters { display:flex; gap:10px; margin-bottom:20px; align-items:center; flex-wrap:wrap; }
    .input-wrapper { position:relative; flex:1; }
    .input-wrapper input { width:100%; padding:10px 14px 10px 40px; border:1px solid #bbb; border-radius:25px; font-size:15px; background:#f9f9f9; transition: all 0.2s ease; }
    .input-wrapper::before { content:"ğŸ”"; position:absolute; left:14px; top:50%; transform:translateY(-50%); font-size:16px; color:#777; }
    .select-wrapper { position:relative; min-width:200px; }
    .select-wrapper select { width:100%; padding:10px 40px 10px 14px; border:1px solid #bbb; border-radius:25px; font-size:15px; background:#f9f9f9; appearance:none; outline:none; }
    .select-wrapper::after { content:"ğŸ“‚"; position:absolute; right:14px; top:50%; transform:translateY(-50%); font-size:16px; color:#777; pointer-events:none; }
    .btn { padding:10px 22px; border:none; border-radius:25px; cursor:pointer; font-weight:600; font-size:15px; text-decoration:none; }
    .btn-primary { background:#007bff; color:white; }
    .btn-secondary { background:#6c757d; color:white; }
    .btn-success { background:#28a745; color:white; }
    .btn-warning { background:#ffc107; color:black; }
    .alert { padding:14px; border-radius:8px; margin-bottom:20px; font-size:15px; }
    .alert.warning { background:#fff3cd; border:1px solid #ffeeba; }
    .low-stock { background:#ffe5e5; font-weight:bold; color:#c00; }
    .reserve-form { display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:center; font-size:15px; }
    .reserve-form input, .reserve-form select { padding:8px 10px; border:1px solid #ccc; border-radius:6px; font-size:15px; }
    .reserve-form button { font-size:15px; margin-top:5px; }
    .qty { width:70px; text-align:center; }
    .out-of-stock { color:#888; font-style:italic; font-size:15px; }

    /* âŒ Error state Ù„Ù„ÙƒÙ…ÙŠØ© */
    .qty.error {
        border: 2px solid #dc3545;
        background: #fff5f5;
    }
    .error-msg {
        color: #dc3545;
        font-size: 13px;
        margin-top: 4px;
        font-weight: 600;
    }

    /* ğŸ¨ Ø£Ù„ÙˆØ§Ù† Ø«Ø§Ø¨ØªØ© Ù„ÙƒÙ„ ÙØ±Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù€ ID */
    .branch-btn {
        padding:12px 24px;
        border-radius:25px;
        font-weight:700;
        font-size:14px;
        border:none;
        margin:4px 0;
        cursor:pointer;
        transition:0.2s;
        color:#fff;
        background:#666; /* Ø§ÙØªØ±Ø§Ø¶ÙŠ */
    }
    .branch-btn:hover { opacity:0.9; transform:scale(1.05); }

    .branch-btn[data-branch-id="1"] { background:#007bff; }   /* ÙØ±Ø¹ 1 = Ø£Ø²Ø±Ù‚ */
    .branch-btn[data-branch-id="2"] { background:#28a745; }   /* ÙØ±Ø¹ 2 = Ø£Ø®Ø¶Ø± */
    .branch-btn[data-branch-id="3"] { background:#ff5722; }   /* ÙØ±Ø¹ 3 = Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
    .branch-btn[data-branch-id="4"] { background:#9c27b0; }   /* ÙØ±Ø¹ 4 = Ø¨Ù†ÙØ³Ø¬ÙŠ */
</style>
{% endblock %}
