{% extends "orders/base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>{{ title }}</h2>

  {% if success %}
    <div class="alert alert-success">✅ تم التعديل بنجاح .. سيتم تحويلك تلقائيًا</div>
    <script>
      setTimeout(function() {
        window.location.href = "{% url redirect_url %}";
      }, 2000); // 2 ثواني
    </script>
  {% else %}
    <form method="post">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit" class="btn btn-success">💾 حفظ</button>
      <a href="{% url 'view_data' %}" class="btn btn-secondary">⬅️ رجوع</a>
    </form>
  {% endif %}
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const mainCategory = document.getElementById("mainCategory");
  const subCategory = document.getElementById("subCategory");

  if (mainCategory && subCategory) {
    // 🔸 عند تغيير القسم الرئيسي
    mainCategory.addEventListener("change", function() {
      const mainId = this.value;
      subCategory.innerHTML = '<option value="">-- اختر القسم الفرعي --</option>';
      subCategory.disabled = true; // يقفل الحقل مؤقتًا

      if (mainId) {
        fetch(`/get-subcategories/?main_id=${mainId}`)
          .then(res => res.json())
          .then(data => {
            data.forEach(sub => {
              const option = document.createElement("option");
              option.value = sub.id;
              option.textContent = sub.name;
              subCategory.appendChild(option);
            });
            subCategory.disabled = false; // يفتحه بعد تحميل البيانات
          })
          .catch(() => {
            subCategory.disabled = false;
          });
      }
    });
  }
});
</script>
{% endblock %}
