{% extends "orders/base.html" %}
{% block title %}لوحة الكول سنتر{% endblock %}

{% block content %}
<div class="cc-dashboard">
    <!-- ✅ الجزء الثابت كله -->
    <div class="header-fixed">
        <h1 class="page-title">☎️ لوحة الكول سنتر</h1>

        <!-- Search + Category Filter + Reservations Button -->
        <form method="get" class="cc-filters">
            <div class="input-wrapper">
                <input type="text" name="q" placeholder="ابحث عن منتج..." value="{{ query|default:'' }}" autofocus>
            </div>
            <div class="select-wrapper">
                <select name="category" onchange="this.form.submit()">
                    <option value="">كل الأقسام</option>
                    {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if selected_category == cat.id %}selected{% endif %}>
                            {{ cat.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary">🔍 بحث</button>
            <a href="{% url 'reservations_list' %}" class="btn btn-secondary ml-auto">
                📋 متابعة الحجوزات
            </a>
        </form>

        <h2 class="section-title">📦 المنتجات والمخزون</h2>
    </div>

    <!-- ✅ الجدول هو اللي Scroll -->
    <div class="table-wrapper">
        <table class="styled-table">
            <thead>
                <tr>
                    <th>المنتج</th>
                    <th>القسم</th>
                    <th>الفروع والكميات</th>
                    <th>الحجز</th>
                </tr>
            </thead>
            <tbody>
            {% regroup inventories by product as product_list %}
            {% for group in product_list %}
                <tr>
                    <td>{{ group.grouper.name }}</td>
                    <td>{{ group.grouper.category.name }}</td>
                    <td>
                        {% for inv in group.list %}
                            {% if inv.quantity > 0 %}
                                🏬 {{ inv.branch.name }}: {{ inv.quantity }}<br>
                            {% endif %}
                        {% endfor %}
                    </td>
                    <td>
                        {% for inv in group.list %}
                            {% if inv.quantity > 0 %}
                                <form method="post" action="{% url 'callcenter_dashboard' %}" class="reserve-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="product_id" value="{{ inv.product.id }}">
                                    <input type="hidden" name="branch_id" value="{{ inv.branch.id }}">
                                    <input type="text" name="customer_name" placeholder="👤 اسم العميل" required>
                                    <input type="text" name="customer_phone" placeholder="📞 موبايل" inputmode="numeric" maxlength="11" pattern="\d{11}"
                                        oninput="this.value=this.value.replace(/\D/g,'').slice(0,11)" >
                                    <select name="delivery_type" required>
                                        <option value="pickup">🚶‍♂️ استلام</option>
                                        <option value="delivery">🚚 توصيل</option>
                                    </select>

                                    <!-- ✅ خانة الكمية مع Error state -->
                                  <input type="number" name="quantity" value="1" min="1"
                                    data-product="{{ inv.product.id }}"
                                    data-branch="{{ inv.branch.id }}"
                                    class="qty {% if quantity_error and quantity_error.product_id == inv.product.id and quantity_error.branch_id == inv.branch.id %}error{% endif %}"
                                    onfocus="this.select()">
                                  <span>{{ inv.product.get_unit_display }}</span>

                                  {% if quantity_error and quantity_error.product_id == inv.product.id and quantity_error.branch_id == inv.branch.id %}
                                    <div class="error-msg">{{ quantity_error.message }}</div>
                                  {% endif %}


                                    <!-- ✅ زرار بلون ثابت حسب ID الفرع -->
                                    <button type="submit" class="btn branch-btn" data-branch-id="{{ inv.branch.id }}">
                                        احجز من {{ inv.branch.name }}
                                    </button>
                                </form>
                            {% endif %}
                        {% endfor %}
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="4">لا توجد نتائج</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
    html, body {
        height: 100%;
        margin: 0;
        overflow: hidden;   /* ❌ يمنع المسطرة الخارجية */
    }

    .cc-dashboard {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;   /* ❌ يمنع أي Scroll إضافي */
    }

    .header-fixed { position: sticky; top: 0; background: #fff; z-index: 20; padding-bottom: 10px; }

    .table-wrapper {
        flex: 1 1 auto;
        overflow-y: auto;   /* ✅ المسطرة الداخلية للجدول فقط */
        border:1px solid #ddd;
        border-radius:8px;
    }

    /* ✨ جدول شيك بخط أكبر */
    .styled-table {
        width:100%;
        border-collapse:collapse;
        font-size:17px;             /* 👈 بدل 15px */
        background: #fff;
        box-shadow:0 2px 8px rgba(0,0,0,0.05); /* ظل بسيط */
        border-radius:8px;
        overflow:hidden;
    }
    .styled-table th, .styled-table td {
        padding:14px;               /* 👈 بدل 12px */
        text-align:center;
        border:1px solid #eee;
    }
    .styled-table th {
        position: sticky;
        top: 0;
        background:#f1f3f6;         /* 👈 أفتح من #f8f9fa */
        z-index: 5;
        font-size:18px;             /* 👈 بدل 16px */
        font-weight:700;            /* 👈 تخن الخط */
        color:#333;
        box-shadow:0 2px 4px rgba(0,0,0,0.05);
    }
    /* 🟢 تأثير شيك على الصفوف */
    .styled-table tbody tr:nth-child(even) {
        background-color: #fafafa;
    }
    .styled-table tbody tr:hover {
        background-color:#fff3cd;
        transition: background 0.2s ease;
    }


    .page-title { font-size:28px; margin-bottom:25px; color:#222; font-weight:700; }
    .section-title { font-size:20px; margin:20px 0; color:#444; font-weight:600; }

    .cc-filters { display:flex; gap:10px; margin-bottom:20px; align-items:center; flex-wrap:wrap; }
    .input-wrapper { position:relative; flex:1; }
    .input-wrapper input { width:100%; padding:10px 14px 10px 40px; border:1px solid #bbb; border-radius:25px; font-size:15px; background:#f9f9f9; transition: all 0.2s ease; }
    .input-wrapper::before { content:"🔍"; position:absolute; left:14px; top:50%; transform:translateY(-50%); font-size:16px; color:#777; }

    .select-wrapper { position:relative; min-width:200px; }
    .select-wrapper select { width:100%; padding:10px 40px 10px 14px; border:1px solid #bbb; border-radius:25px; font-size:15px; background:#f9f9f9; appearance:none; outline:none; }
    .select-wrapper::after { content:"📂"; position:absolute; right:14px; top:50%; transform:translateY(-50%); font-size:16px; color:#777; pointer-events:none; }

    .btn { padding:10px 22px; border:none; border-radius:25px; cursor:pointer; font-weight:600; font-size:15px; text-decoration:none; }
    .btn-primary { background:#007bff; color:white; }
    .btn-secondary { background:#6c757d; color:white; }
    .btn-success { background:#28a745; color:white; }
    .btn-warning { background:#ffc107; color:black; }

    .alert { padding:14px; border-radius:8px; margin-bottom:20px; font-size:15px; }
    .alert.warning { background:#fff3cd; border:1px solid #ffeeba; }

    .low-stock { background:#ffe5e5; font-weight:bold; color:#c00; }

    .reserve-form { display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:center; font-size:15px; }
    .reserve-form input, .reserve-form select { padding:8px 10px; border:1px solid #ccc; border-radius:6px; font-size:15px; }
    .reserve-form button { font-size:15px; margin-top:5px; }
    .qty { width:70px; text-align:center; }
    .out-of-stock { color:#888; font-style:italic; font-size:15px; }

    /* ❌ Error state للكمية */
    .qty.error {
        border: 2px solid #dc3545;
        background: #fff5f5;
    }
    .error-msg {
        color: #dc3545;
        font-size: 13px;
        margin-top: 4px;
        font-weight: 600;
    }

    /* 🎨 ألوان ثابتة لكل فرع حسب الـ ID */
    .branch-btn {
        padding:12px 24px;
        border-radius:25px;
        font-weight:700;
        font-size:14px;
        border:none;
        margin:4px 0;
        cursor:pointer;
        transition:0.2s;
        color:#fff;
        background:#666; /* افتراضي */
    }
    .branch-btn:hover { opacity:0.9; transform:scale(1.05); }

    .branch-btn[data-branch-id="1"] { background:#007bff; }   /* فرع 1 = أزرق */
    .branch-btn[data-branch-id="2"] { background:#28a745; }   /* فرع 2 = أخضر */
    .branch-btn[data-branch-id="3"] { background:#ff5722; }   /* فرع 3 = برتقالي */
    .branch-btn[data-branch-id="4"] { background:#9c27b0; }   /* فرع 4 = بنفسجي */
</style>
{% if quantity_error %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    var row = document.querySelector(
        'input[name="quantity"][data-product="{{ quantity_error.product_id }}"][data-branch="{{ quantity_error.branch_id }}"]'
    );
    if(row) {
        // نجيب مكان العنصر بالنسبة للصفحة
        var y = row.getBoundingClientRect().top + window.scrollY;

        // نطرح ارتفاع البار الثابت (مثلاً 100 بكسل حسب طول النافبار عندك)
        var offset = 120; // عدل الرقم ده حسب طول البار من base.html

        window.scrollTo({
            top: y - offset,
            behavior: "smooth"
        });

        row.focus();  // يحط الكيرسور جوه
    }
});
</script>
{% endif %}
{% endblock %}
