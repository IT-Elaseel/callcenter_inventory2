{% extends "orders/base.html" %}
{% block title %}لوحة الكول سنتر{% endblock %}

{% block content %}
<div class="cc-dashboard">
    <div class="header-fixed">
        <h1 class="page-title">☎️ لوحة الكول سنتر</h1>

        <!-- ✅ الفلاتر -->
        <form method="get" class="cc-filters">
            <div class="input-wrapper">
                <input type="text" name="q" placeholder="ابحث عن منتج..." value="{{ query|default:'' }}" autofocus>
            </div>
            <div class="select-wrapper">
                <select name="category" onchange="this.form.submit()">
                    <option value="">كل الأقسام</option>
                    {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if selected_category == cat.id %}selected{% endif %}>
                            {{ cat.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary">🔍 بحث</button>
            <a href="{% url 'reservations_list' %}" class="btn btn-secondary ml-auto">📋 متابعة الحجوزات</a>
        </form>

        <h2 class="section-title">📦 المنتجات والمخزون</h2>
    </div>

    <div class="table-wrapper">
        <table class="styled-table">
            <thead>
                <tr>
                    <th>المنتج</th>
                    <th>القسم</th>
                    <th>الفروع والكميات</th>
                    <th>الحجز</th>
                </tr>
            </thead>
            <tbody>
            {% regroup inventories by product as product_list %}
            {% for group in product_list %}
                <tr>
                    <td>{{ group.grouper.name }}</td>
                    <td>{{ group.grouper.category.name }}</td>
                    <td>
                        {% for inv in group.list %}
                            {% if inv.quantity > 0 %}
                                🏬 {{ inv.branch.name }}: {{ inv.quantity }}<br>
                            {% endif %}
                        {% endfor %}
                    </td>
                    <td>
                        {% for inv in group.list %}
                            {% if inv.quantity > 0 %}
                                <!-- ✅ الفورم بقى يستخدم onsubmit فقط -->
                                <form method="post" class="reserve-form" onsubmit="reserveProduct(event, this)">
                                    {% csrf_token %}
                                    <input type="hidden" name="product_id" value="{{ inv.product.id }}">
                                    <input type="hidden" name="branch_id" value="{{ inv.branch.id }}">
                                    <input type="text" name="customer_name" placeholder="👤 اسم العميل" required>
                                    <input type="text" name="customer_phone" placeholder="📞 موبايل" inputmode="numeric" maxlength="11"
                                        pattern="\d{11}" oninput="this.value=this.value.replace(/\D/g,'').slice(0,11)" >
                                    <select name="delivery_type" required>
                                        <option value="pickup">🚶‍♂️ استلام</option>
                                        <option value="delivery">🚚 توصيل</option>
                                    </select>

                                    <input type="number" name="quantity" value="1" min="1"
                                        data-product="{{ inv.product.id }}"
                                        data-branch="{{ inv.branch.id }}"
                                        class="qty" onfocus="this.select()">
                                    <span>{{ inv.product.get_unit_display }}</span>

                                    <button type="submit" class="btn branch-btn" data-branch-id="{{ inv.branch.id }}">
                                        احجز من {{ inv.branch.name }}
                                    </button>
                                </form>
                            {% endif %}
                        {% endfor %}
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="4">لا توجد نتائج</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
    html, body {
        height: 100%;
        margin: 0;
        overflow: hidden;   /* ❌ يمنع المسطرة الخارجية */
    }

    .cc-dashboard {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;   /* ❌ يمنع أي Scroll إضافي */
    }

    .header-fixed { position: sticky; top: 0; background: #fff; z-index: 20; padding-bottom: 10px; }

    .table-wrapper {
        flex: 1 1 auto;
        overflow-y: auto;   /* ✅ المسطرة الداخلية للجدول فقط */
        border:1px solid #ddd;
        border-radius:8px;
    }

    /* ✨ جدول شيك بخط أكبر */
    .styled-table {
        width:100%;
        border-collapse:collapse;
        font-size:17px;             /* 👈 بدل 15px */
        background: #fff;
        box-shadow:0 2px 8px rgba(0,0,0,0.05); /* ظل بسيط */
        border-radius:8px;
        overflow:hidden;
    }
    .styled-table th, .styled-table td {
        padding:14px;               /* 👈 بدل 12px */
        text-align:center;
        border:1px solid #eee;
    }
    .styled-table th {
        position: sticky;
        top: 0;
        background:#f1f3f6;         /* 👈 أفتح من #f8f9fa */
        z-index: 5;
        font-size:18px;             /* 👈 بدل 16px */
        font-weight:700;            /* 👈 تخن الخط */
        color:#333;
        box-shadow:0 2px 4px rgba(0,0,0,0.05);
    }
    /* 🟢 تأثير شيك على الصفوف */
    .styled-table tbody tr:nth-child(even) {
        background-color: #fafafa;
    }
    .styled-table tbody tr:hover {
        background-color:#fff3cd;
        transition: background 0.2s ease;
    }


    .page-title { font-size:28px; margin-bottom:25px; color:#222; font-weight:700; }
    .section-title { font-size:20px; margin:20px 0; color:#444; font-weight:600; }

    .cc-filters { display:flex; gap:10px; margin-bottom:20px; align-items:center; flex-wrap:wrap; }
    .input-wrapper { position:relative; flex:1; }
    .input-wrapper input { width:100%; padding:10px 14px 10px 40px; border:1px solid #bbb; border-radius:25px; font-size:15px; background:#f9f9f9; transition: all 0.2s ease; }
    .input-wrapper::before { content:"🔍"; position:absolute; left:14px; top:50%; transform:translateY(-50%); font-size:16px; color:#777; }

    .select-wrapper { position:relative; min-width:200px; }
    .select-wrapper select { width:100%; padding:10px 40px 10px 14px; border:1px solid #bbb; border-radius:25px; font-size:15px; background:#f9f9f9; appearance:none; outline:none; }
    .select-wrapper::after { content:"📂"; position:absolute; right:14px; top:50%; transform:translateY(-50%); font-size:16px; color:#777; pointer-events:none; }

    .btn { padding:10px 22px; border:none; border-radius:25px; cursor:pointer; font-weight:600; font-size:15px; text-decoration:none; }
    .btn-primary { background:#007bff; color:white; }
    .btn-secondary { background:#6c757d; color:white; }
    .btn-success { background:#28a745; color:white; }
    .btn-warning { background:#ffc107; color:black; }

    .alert { padding:14px; border-radius:8px; margin-bottom:20px; font-size:15px; }
    .alert.warning { background:#fff3cd; border:1px solid #ffeeba; }

    .low-stock { background:#ffe5e5; font-weight:bold; color:#c00; }

    .reserve-form { display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:center; font-size:15px; }
    .reserve-form input, .reserve-form select { padding:8px 10px; border:1px solid #ccc; border-radius:6px; font-size:15px; }
    .reserve-form button { font-size:15px; margin-top:5px; }
    .qty { width:70px; text-align:center; }
    .out-of-stock { color:#888; font-style:italic; font-size:15px; }

    /* ❌ Error state للكمية */
    .qty.error {
        border: 2px solid #dc3545;
        background: #fff5f5;
    }
    .error-msg {
        color: #dc3545;
        font-size: 13px;
        margin-top: 4px;
        font-weight: 600;
    }

    /* 🎨 ألوان ثابتة لكل فرع حسب الـ ID */
    .branch-btn {
        padding:12px 24px;
        border-radius:25px;
        font-weight:700;
        font-size:14px;
        border:none;
        margin:4px 0;
        cursor:pointer;
        transition:0.2s;
        color:#fff;
        background:#666; /* افتراضي */
    }
    .branch-btn:hover { opacity:0.9; transform:scale(1.05); }

    .branch-btn[data-branch-id="1"] { background:#007bff; }   /* فرع 1 = أزرق */
    .branch-btn[data-branch-id="2"] { background:#28a745; }   /* فرع 2 = أخضر */
    .branch-btn[data-branch-id="3"] { background:#ff5722; }   /* فرع 3 = برتقالي */
    .branch-btn[data-branch-id="4"] { background:#9c27b0; }   /* فرع 4 = بنفسجي */
</style>

<script>
// ========================================================
// 1️⃣ WebSocket للكول سنتر
// ========================================================
const callSocket = new WebSocket(
  (window.location.protocol === "https:" ? "wss://" : "ws://") +
  window.location.host +
  "/ws/callcenter/"
);

callSocket.onopen = () => console.log("✅ Connected to CallCenter WS");

callSocket.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log("📦 Update:", data);

  // 🟢 لو الرسالة فيها منتج وفرع وكمية
  if (data.product_id && data.branch_id && data.new_qty !== undefined) {
    const qtyInput = document.querySelector(
      `.reserve-form input[data-product='${data.product_id}'][data-branch='${data.branch_id}']`
    );

    // ✅ الحالة 1: المنتج موجود بالفعل → حدث الكمية
    if (qtyInput) {
      const cell = qtyInput.closest("tr").querySelector("td:nth-child(3)");
      if (cell) {
        const regex = new RegExp(`🏬\\s*${data.branch_name}:\\s*\\d+`, "g");
        if (cell.innerHTML.match(regex)) {
          // تحديث الكمية داخل نفس الفرع
          cell.innerHTML = cell.innerHTML.replace(
            regex,
            `🏬 ${data.branch_name}: ${data.new_qty}`
          );
        } else {
          // لو الفرع ده مش مذكور ضمن الكميات → أضفه
          cell.innerHTML += `<br>🏬 ${data.branch_name}: ${data.new_qty}`;
        }
      }
    }

    // 🆕 الحالة 2: المنتج مش موجود في الجدول → أضفه (upsert)
    else if (data.action === "upsert" && data.new_qty > 0) {
      addNewProductRow(data);
    }
  }

  if (data.message) showToast(data.message, "info");
};

callSocket.onclose = () => console.warn("⚠️ CallCenter WebSocket closed");

// ========================================================
// 2️⃣ دالة لإضافة صف منتج جديد لو مش موجود (بكامل الفورم)
// ========================================================
function addNewProductRow(data) {
  const tbody = document.querySelector(".styled-table tbody");
  if (!tbody) return;

  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${data.product_name}</td>
    <td>${data.category_name || "-"}</td>
    <td>🏬 ${data.branch_name}: ${data.new_qty}</td>
    <td>
      <form method="post" class="reserve-form" onsubmit="reserveProduct(event, this)">
        <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
        <input type="hidden" name="product_id" value="${data.product_id}">
        <input type="hidden" name="branch_id" value="${data.branch_id}">
        <input type="text" name="customer_name" placeholder="👤 اسم العميل" required>
        <input type="text" name="customer_phone" placeholder="📞 موبايل"
               inputmode="numeric" maxlength="11"
               pattern="\\d{11}" oninput="this.value=this.value.replace(/\\D/g,'').slice(0,11)">
        <select name="delivery_type" required>
          <option value="pickup">🚶‍♂️ استلام</option>
          <option value="delivery">🚚 توصيل</option>
        </select>
        <input type="number" name="quantity" value="1" min="1"
               data-product="${data.product_id}"
               data-branch="${data.branch_id}"
               class="qty" onfocus="this.select()">
        <span>${data.unit || "عدد"}</span>
        <button type="submit" class="btn branch-btn" data-branch-id="${data.branch_id}">
          احجز من ${data.branch_name}
        </button>
      </form>
    </td>
  `;
  tbody.prepend(row);
}

// ========================================================
// 3️⃣ تنفيذ الحجز بـ Ajax بدون Reload
// ========================================================
async function reserveProduct(event, form) {
  event.preventDefault();

  const formData = new FormData(form);
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  try {
    const response = await fetch("{% url 'callcenter' %}", {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRFToken": csrftoken,
        "X-Requested-With": "XMLHttpRequest",
      },
      credentials: "same-origin"
    });

    const data = await response.json();
    console.log("🧾 Server response:", data);

    if (data.success) {
      showToast(data.message || "✅ تم تسجيل الحجز بنجاح", "success");
      form.reset();

      // 🟢 لو الكمية الجديدة بقت صفر، نخفي المنتج من الجدول
      if (data.new_qty === 0) {
        const row = form.closest("tr");
        if (row) row.remove();
      }
    } else {
      showToast(data.message || "❌ حدث خطأ أثناء الحجز", "error");
    }

  } catch (err) {
    console.error("Fetch error:", err);
    showToast("⚠️ فشل الاتصال بالسيرفر", "error");
  }
}

// ========================================================
// 4️⃣ Toast Notification
// ========================================================
function showToast(message, type) {
  const color = type === "success" ? "#28a745" :
                type === "error" ? "#dc3545" : "#007bff";
  const toast = document.createElement("div");
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed; bottom: 20px; right: 20px;
    background: ${color}; color: white;
    padding: 10px 15px; border-radius: 6px;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
    z-index: 9999; font-size: 14px;
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}
