{% extends "orders/base.html" %}
{% block title %}لوحة الحجوزات{% endblock %}

{% block content %}
<!DOCTYPE html>
<html>
<head>
    <title>Reservations</title>
    <style>
        body { font-family: Arial, sans-serif; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background: #f4f4f4; }
        .pending { background: #fff0b3; }
        .confirmed { background: #c6f6c6; }
        .cancelled { background: #ffcccc; }
    </style>
</head>
<body>
<div style="display:flex; justify-content:space-between; align-items:center;">
  <h1>📋 Reservations Dashboard</h1>
  <a href="{% url 'home' %}"
     style="padding:8px 16px; background:#007bff; color:#fff; text-decoration:none; border-radius:5px; transition:0.3s;">
     ⬅ العودة للمنتجات
  </a>
</div>
<form method="get" class="mb-3">
  <div style="display:flex; gap:15px; align-items:flex-end; flex-wrap:wrap;">
    <div class="form-group">
      <label class="form-label">من:</label>
      <input type="date" class="form-control" name="start_date" value="{{ start_date|default:'' }}">
    </div>
    <div class="form-group">
      <label class="form-label">إلى:</label>
      <input type="date" class="form-control" name="end_date" value="{{ end_date|default:'' }}">
    </div>
    <div class="form-group">
      <label class="form-label">بحث:</label>
      <input type="text" class="form-control" name="q" value="{{ query|default:'' }}" placeholder="اسم العميل أو رقم الهاتف">
    </div>
    <div>
      <button type="submit" class="btn btn-primary">عرض</button>
    </div>
  </div>
</form>

    <table>
        <tr>
            <th>ID</th>
            <th>Customer</th>
            <th>Phone</th>
            <th>Product</th>
            <th>Quantity</th>
            <th>Branch</th>
            <th>Delivery Type</th>
            <th>Status</th>
            <th>Created At</th>
            <th>Decision At</th>
            <th>Last Branch Action</th>
            <th>Reserved By</th>
            <th>Actions</th>
        </tr>
        {% for res in reservations %}
        <tr class="{{ res.status }}">
            <td>{{ res.id }}</td>
            <td>{{ res.customer.name }}</td>
            <td>{{ res.customer.phone }}</td>
            <td>{{ res.product.name }}</td>
            <td>{{ res.quantity }}</td>
            <td>{{ res.branch.name }}</td>
            <td>{{ res.get_delivery_type_display }}</td>
            <td>{{ res.get_status_display }}</td>
            <td>{{ res.created_at|date:"Y-m-d H:i" }}</td>
            <td>{{ res.decision_at|date:"Y-m-d H:i" }}</td>
            <td>
                {% if res.branch_last_modified_at %}
                    {{ res.branch_last_modified_at|date:"Y-m-d H:i" }}
                {% else %}-{% endif %}
            </td>
            <td>
                {% if res.reserved_by %}
                    {{ res.reserved_by.username }} ({{ res.created_at|date:"Y-m-d H:i" }})
                {% else %}-{% endif %}
            </td>
            <td>
                {% if user_role == "branch" or user_role == "admin" %}
                    {% if res.status == "pending" %}
                        <a href="{% url 'update_reservation_status' res.id 'confirmed' %}">✅ Confirm</a> |
                        <a href="{% url 'update_reservation_status' res.id 'cancelled' %}">❌ Cancel</a>
                    {% elif res.status == "confirmed" %}
                        <a href="{% url 'update_reservation_status' res.id 'cancelled' %}">❌ Cancel</a>
                    {% elif res.status == "cancelled" %}
                        <a href="{% url 'update_reservation_status' res.id 'confirmed' %}">✅ Re-Confirm</a>
                    {% endif %}
                {% else %}
                    - <!-- الكول سنتر يشوف بس -->
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr><td colspan="12">لا توجد حجوزات</td></tr>
        {% endfor %}
    </table>
</body>
</html>
{% endblock %}
