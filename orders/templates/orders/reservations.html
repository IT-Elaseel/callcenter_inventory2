{% extends "orders/base.html" %}
{% block title %}📋 لوحة الحجوزات{% endblock %}

{% block content %}
<div class="inventory-dashboard">

  <!-- ✅ الهيدر -->
  <div class="header-fixed">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="m-0" style="font-size: 1.5rem;">
        📋 لوحة الحجوزات
      </h1>
    </div>

    <!-- 🔽 الفلاتر -->
    <form method="get" id="filterForm" class="filters row g-3 align-items-end">
      <div class="col-md-2">
        <label class="form-label">من:</label>
        <input type="date" class="form-control" name="start_date" value="{{ start_date|default:'' }}"max="{{ today|date:'Y-m-d' }}">
      </div>

      <div class="col-md-2">
        <label class="form-label">إلى:</label>
        <input type="date" class="form-control" name="end_date" value="{{ end_date|default:'' }}"max="{{ today|date:'Y-m-d' }}">
      </div>

      <div class="col-md-2">
        <label class="form-label">بحث:</label>
        <input type="text" class="form-control" name="q" value="{{ query|default:'' }}" placeholder="اسم العميل أو رقم الهاتف">
      </div>

      <div class="col-md-3">
        <button type="submit" class="custom-btn btn-success btn-view">عرض</button>
      </div>
    </form>
  </div>

  <!-- ✅ الجدول -->
  <div class="table-wrapper">
    <table class="styled-table">
      <thead>
        <tr>
          <th>رقم الحجز</th>
          <th>العميل</th>
          <th>رقم الهاتف</th>
          <th>المنتج</th>
          <th>الكمية</th>
          <th>الفرع</th>
          <th>طريقة التوصيل</th>
          <th>الحالة</th>
          <th>تاريخ الإنشاء</th>
          <th>تاريخ القرار</th>
          <th>آخر إجراء للفرع</th>
          <th>تم الحجز بواسطة</th>
          <th>الإجراءات</th>
        </tr>
      </thead>
      <tbody>
        {% for res in reservations %}
        <tr id="res-row-{{ res.id }}">
          <td>{{ res.id }}</td>
          <td>{{ res.customer.name }}</td>
          <td>{{ res.customer.phone }}</td>
          <td>{{ res.product.name }}</td>
          <td>{{ res.quantity }}</td>
          <td>{{ res.branch.name }}</td>
          <td>{{ res.get_delivery_type_display }}</td>
          <td>{{ res.get_status_display }}</td>
          <td>{{ res.created_at|date:"Y-m-d H:i:s" }}</td>
          <td>{{ res.decision_at|date:"Y-m-d H:i:s" }}</td>
          <td>
            {% if res.branch_last_modified_at %}
              {{ res.branch_last_modified_at|date:"Y-m-d H:i:s" }}
            {% else %}-{% endif %}
          </td>
          <td>
            {% if res.reserved_by %}
              {{ res.reserved_by.username }}
            {% else %}-{% endif %}
          </td>
          <td>
            {% if user_role == "branch" or user_role == "admin" %}
              {% if res.status == "pending" %}
                <a href="{% url 'update_reservation_status' res.id 'confirmed' %}" class="custom-btn btn-success btn-sm">✅ تأكيد</a>
                <a href="{% url 'update_reservation_status' res.id 'cancelled' %}" class="custom-btn btn-danger btn-sm">❌ إلغاء</a>
              {% elif res.status == "confirmed" %}
                <a href="{% url 'update_reservation_status' res.id 'cancelled' %}" class="custom-btn btn-danger btn-sm">❌ إلغاء</a>
              {% elif res.status == "cancelled" %}
                <a href="{% url 'update_reservation_status' res.id 'confirmed' %}" class="custom-btn btn-success btn-sm">✅ إعادة تأكيد</a>
              {% endif %}
            {% else %}
              -
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="13" class="text-center">❌ لا توجد حجوزات</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<style>
  html, body { height: 100%; margin: 0; overflow: hidden; }

  .inventory-dashboard {
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }

  .header-fixed {
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 20;
    padding-bottom: 10px;
    border-bottom: 2px solid #ddd;
  }

  .filters { margin-bottom: 10px; }

  .table-wrapper {
    flex: 1 1 auto;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 8px;
  }

  .styled-table {
    width: 90%;
    margin: 20px auto;
    border-collapse: collapse;
    font-size: 15px;
  }

  .styled-table th, .styled-table td {
    padding: 6px 8px;
    text-align: center;
    border: 1px solid #eee;
  }

  .styled-table th {
    position: sticky;
    top: 0;
    background: #000;
    color: #fff;
    font-weight: bold;
    z-index: 5;
    font-size: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  .styled-table tbody tr:hover {
    background: #f8d7da;
    transition: background 0.2s ease-in-out;
    cursor: pointer;
  }

  h1.m-0 {
    font-size: 1.5rem !important;
    font-weight: bold;
    margin: 0;
  }

  .custom-btn {
    padding: 5px 15px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 6px;
    transition: all 0.3s ease-in-out;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border: none;
    color: #fff;
    display: inline-block;
    text-decoration: none;
  }

  /* ✅ زر التأكيد */
  .btn-success.custom-btn {
    background: linear-gradient(135deg, #28a745, #34ce57);
  }
  .btn-success.custom-btn:hover {
    background: linear-gradient(135deg, #218838, #28a745);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  /* ❌ زر الإلغاء */
  .btn-danger.custom-btn {
    background: linear-gradient(135deg, #dc3545, #e4606d);
  }
  .btn-danger.custom-btn:hover {
    background: linear-gradient(135deg, #c82333, #dc3545);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  .custom-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  /* الزرار بتاع عرض فقط */
.btn-view {
  padding: 8px 25px;   /* يكبر الطول + العرض */
  font-size: 16px;      /* خط أكبر */
  border-radius: 8px;
}
</style>
<script>
// ========================================================
// 🔄 WebSocket لتحديث الحجوزات لحظيًا بدون Refresh
// ========================================================
const reservationsSocket = new WebSocket(
  (window.location.protocol === "https:" ? "wss://" : "ws://") +
  window.location.host +
  "/ws/reservations/"
);

reservationsSocket.onopen = () => console.log("✅ Connected to Reservations WS");
reservationsSocket.onclose = () => console.warn("⚠️ Reservations WS closed");

const USER_ROLE = "{{ user_role|default:'guest' }}";
// هنستخدم تمبلت URL ونبدّل الـ ID جوّه
const CONFIRM_URL_TMPL = "{% url 'update_reservation_status' 999999 'confirmed' %}";
const CANCEL_URL_TMPL  = "{% url 'update_reservation_status' 999999 'cancelled' %}";
const tbody = document.querySelector(".styled-table tbody");

function replaceId(urlTemplate, id) { return urlTemplate.replace("999999", id); }

function buildRowHtml(d) {
  // لو الصفحة فيها صلاحيات فرع/أدمن نظهر الأزرار
  let actions = "-";
  if (USER_ROLE === "branch" || USER_ROLE === "admin") {
    if (d.status === "قيد الانتظار" || d.status === "Pending") {
      actions = `
        <a href="${replaceId(CONFIRM_URL_TMPL, d.reservation_id)}" class="custom-btn btn-success btn-sm">✅ تأكيد</a>
        <a href="${replaceId(CANCEL_URL_TMPL, d.reservation_id)}"  class="custom-btn btn-danger btn-sm">❌ إلغاء</a>
      `;
    } else if (d.status === "مؤكد" || d.status === "Confirmed") {
      actions = `<a href="${replaceId(CANCEL_URL_TMPL, d.reservation_id)}" class="custom-btn btn-danger btn-sm">❌ إلغاء</a>`;
    } else if (d.status === "ملغي" || d.status === "Cancelled") {
      actions = `<a href="${replaceId(CONFIRM_URL_TMPL, d.reservation_id)}" class="custom-btn btn-success btn-sm">✅ إعادة تأكيد</a>`;
    }
  }

  return `
    <tr id="res-row-${d.reservation_id}">
      <td>${d.reservation_id}</td>
      <td>${d.customer_name || "-"}</td>
      <td>${d.customer_phone || "-"}</td>
      <td>${d.product_name}</td>
      <td>${d.quantity}</td>
      <td>${d.branch_name}</td>
      <td>${d.delivery_type}</td>
      <td>${d.status}</td>
      <td>${d.created_at || "-"}</td>
      <td>${d.decision_at || "-"}</td>
      <td>${d.branch_last_modified_at || "-"}</td>
      <td>${d.reserved_by || "-"}</td>
      <td>${actions}</td>
    </tr>
  `;
}

function insertOrUpdateRow(d) {
  const rowId = `res-row-${d.reservation_id}`;
  let row = document.getElementById(rowId);

  if (!row) {
    // صف جديد → نضيفه في أول الجدول
    const tmp = document.createElement("tbody");
    tmp.innerHTML = buildRowHtml(d).trim();
    const newRow = tmp.firstElementChild;
    tbody.prepend(newRow);
  } else {
    // تحديث صف موجود (تغيير حالة مثلاً)
    row.outerHTML = buildRowHtml(d);
  }
}

reservationsSocket.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log("📋 Reservations update:", data);

  if (data.message) showToast(data.message, "info");

  // new حجز جديد → ضيف صف
  if (data.action === "new") {
    insertOrUpdateRow(data);
  }
  // status_change → عدّل الصف
  else if (data.action === "status_change") {
    insertOrUpdateRow(data);
  }
};

// ✅ Toast صغير
function showToast(message, type) {
  const color = type === "success" ? "#28a745" :
                type === "error" ? "#dc3545" : "#007bff";
  const toast = document.createElement("div");
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed; bottom: 20px; right: 20px;
    background: ${color}; color: white;
    padding: 10px 15px; border-radius: 6px;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
    z-index: 9999; font-size: 14px;
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}
