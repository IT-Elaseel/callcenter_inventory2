{% extends "orders/base.html" %}
{% block title %}عرض البيانات{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>📊 عرض البيانات</h2>

  <!-- 🔽 اختيار الجدول اللي هيظهر -->
  <form method="get" class="mb-3 d-flex gap-2 align-items-center flex-wrap" id="filterForm">
    <label class="form-label">اختر الجدول:</label>

    <select name="table" class="form-select" style="max-width:200px;" onchange="this.form.submit()">
      <option value="categories" {% if selected_table == "categories" %}selected{% endif %}>الأقسام</option>
      <option value="products" {% if selected_table == "products" %}selected{% endif %}>المنتجات</option>
      <option value="branches" {% if selected_table == "branches" %}selected{% endif %}>الفروع</option>
    </select>

    {% if selected_table == "products" %}
      <!-- ✅ الفلاتر الخاصة بالمنتجات -->
      <div class="d-flex align-items-center gap-2 flex-nowrap overflow-auto" style="white-space: nowrap;">
        <!-- القسم الرئيسي -->
        <select id="categorySelect" name="category" class="form-select" style="max-width:200px;" onchange="this.form.submit()">
          <option value="">-- كل الأقسام الرئيسية --</option>
          {% for c in categories %}
            <option value="{{ c.id }}" {% if selected_category == c.id|stringformat:"s" %}selected{% endif %}>
              {{ c.name }}
            </option>
          {% endfor %}
        </select>

        <!-- القسم الفرعي -->
        <select id="subcategorySelect" name="subcategory" class="form-select" style="max-width:200px;" onchange="this.form.submit()">
          <option value="">-- كل الأقسام الفرعية --</option>
          {% for s in second_categories %}
            {% if not selected_category or s.main_category.id|stringformat:"s" == selected_category %}
              <option value="{{ s.id }}" {% if selected_subcategory == s.id|stringformat:"s" %}selected{% endif %}>
                {{ s.name }}
              </option>
            {% endif %}
          {% endfor %}
        </select>

        <!-- 🟢 فلتر التوفر -->
        <select name="availability" class="form-select" style="max-width:170px;" onchange="this.form.submit()">
          <option value="available" {% if availability == "available" %}selected{% endif %}>🟢 المتوفر فقط</option>
          <option value="unavailable" {% if availability == "unavailable" %}selected{% endif %}>🔴 غير المتوفر فقط</option>
          <option value="all" {% if availability == "all" %}selected{% endif %}>⚪ الكل</option>
        </select>

        <!-- 🔍 البحث -->
        <input type="text" name="q" class="form-control  flex-shrink-0" placeholder="بحث عن منتج..."value="{{ query|default:'' }}" style="max-width:220px; min-width:180px;">
      </div>
    {% endif %}
  </form>

  <!-- ✅ جدول الأقسام -->
  {% if selected_table == "categories" %}
    <h5>الأقسام</h5>
    <table class="table table-striped table-bordered">
      <thead class="table-primary">
        <tr>
          <th>#</th>
          <th>الاسم</th>
          <th>الوصف</th>
          <th>تاريخ آخر تعديل</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody>
        {% for c in categories %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ c.name }}</td>
            <td>{{ c.description }}</td>
            <td>{{ c.updated_at|date:"Y-m-d H:i" }}</td>
            <td>
              <a href="{% url 'edit_category' c.id %}?table={{ selected_table }}" class="btn btn-sm btn-warning">✏️ تعديل</a>
              <form method="post" class="delete-form d-inline">
                {% csrf_token %}
                <input type="hidden" name="delete_category" value="{{ c.id }}">
                <button type="submit" class="btn btn-sm btn-danger">🗑 حذف</button>
              </form>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="5">لا توجد أقسام</td></tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <!-- ✅ جدول المنتجات -->
  {% if selected_table == "products" %}
    <h5>المنتجات</h5>
    <table class="table table-striped table-bordered align-middle text-center">
      <thead class="table-success">
        <tr>
          <th>#</th>
          <th>الاسم</th>
          <th>القسم الرئيسي</th>
          <th>القسم الفرعي</th>
          <th>السعر</th>
          <th>الوحدة</th>
          <th>الحالة</th>
          <th>تاريخ آخر تعديل</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody>
        {% for p in products %}
          <tr class="{% if not p.is_available %}table-secondary{% endif %}">
            <td>{{ forloop.counter }}</td>
            <td>{{ p.name }}</td>
            <td>{{ p.category.name|default:"—" }}</td>
            <td>{{ p.second_category.name|default:"—" }}</td>
            <td>{{ p.price }}</td>
            <td>{{ p.get_unit_display }}</td>
            <td>{% if p.is_available %}✅ متوفر{% else %}❌ غير متوفر{% endif %}</td>
            <td>{{ p.updated_at|date:"Y-m-d H:i" }}</td>
            <td>
              <!-- ✏️ تعديل -->
              <a href="{% url 'edit_product' p.id %}?table={{ selected_table }}&q={{ query }}&category={{ selected_category }}&subcategory={{ selected_subcategory }}"
                 class="btn btn-sm btn-warning mb-1">✏️ تعديل</a>

              <!-- 🗑 حذف -->
              <form method="post" class="delete-form d-inline">
                {% csrf_token %}
                <input type="hidden" name="delete_product" value="{{ p.id }}">
                <button type="submit" class="btn btn-sm btn-danger mb-1">🗑 حذف</button>
              </form>

              <!-- 🔁 تبديل التوفر -->
              <button type="button"
                      class="btn btn-sm toggle-btn {% if p.is_available %}btn-success{% else %}btn-secondary{% endif %}"
                      data-id="{{ p.id }}">
                {% if p.is_available %}🟢 متوفر{% else %}🔴 غير متوفر{% endif %}
              </button>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="9" class="text-center">لا توجد منتجات</td></tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <!-- ✅ جدول الفروع -->
  {% if selected_table == "branches" %}
    <h5>الفروع</h5>
    <table class="table table-striped table-bordered">
      <thead class="table-info">
        <tr>
          <th>#</th>
          <th>الاسم</th>
          <th>العنوان</th>
          <th>الهاتف</th>
          <th>تاريخ آخر تعديل</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody>
        {% for b in branches %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ b.name }}</td>
            <td>{{ b.address }}</td>
            <td>{{ b.phone }}</td>
            <td>{{ b.updated_at|date:"Y-m-d H:i" }}</td>
            <td>
              <a href="{% url 'edit_branch' b.id %}?table={{ selected_table }}" class="btn btn-sm btn-warning">✏️ تعديل</a>
              <form method="post" class="delete-form d-inline">
                {% csrf_token %}
                <input type="hidden" name="delete_branch" value="{{ b.id }}">
                <button type="submit" class="btn btn-sm btn-danger">🗑 حذف</button>
              </form>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="6">لا توجد فروع</td></tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
</div>

<!-- 🔽 JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById("filterForm");
    const categorySelect = document.getElementById("categorySelect");
    const subcategorySelect = document.getElementById("subcategorySelect");
    const searchInput = document.getElementById("searchInput");

    // ✅ تحديث الأقسام الفرعية عند تغيير القسم الرئيسي
    categorySelect?.addEventListener("change", function() {
      const mainId = this.value;
      subcategorySelect.innerHTML = '<option value="">-- كل الأقسام الفرعية --</option>';
      if (mainId) {
        fetch(`/get-subcategories/?main_id=${mainId}`)
          .then(res => res.json())
          .then(data => {
            data.forEach(sub => {
              const option = document.createElement("option");
              option.value = sub.id;
              option.textContent = sub.name;
              subcategorySelect.appendChild(option);
            });
          })
          .finally(() => form.submit());
      } else {
        form.submit();
      }
    });

    // ✅ البحث التلقائي أثناء الكتابة
    let timer;
    searchInput?.addEventListener("input", function() {
      clearTimeout(timer);
      timer = setTimeout(() => form.submit(), 500);
    });

    // ✅ تحديث النتائج تلقائي عند تغيير القسم الفرعي
    subcategorySelect?.addEventListener("change", function() {
      form.submit();
    });

    // ✅ تأكيد الحذف
    document.querySelectorAll(".delete-form").forEach(formEl => {
      formEl.addEventListener("submit", function(e) {
        e.preventDefault();
        Swal.fire({
          title: "هل أنت متأكد؟",
          text: "لا يمكن التراجع بعد الحذف!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "🗑 نعم، احذف",
          cancelButtonText: "إلغاء"
        }).then((result) => {
          if (result.isConfirmed) this.submit();
        });
      });
    });
  });
// -------------------------------------------------------------------------------------------------------
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll(".toggle-btn").forEach(btn => {
    btn.addEventListener("click", function() {
      const productId = this.dataset.id;
      fetch(`/toggle-product/${productId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
        },
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // ✅ غيّر شكل الزرار حسب الحالة الجديدة
          if (data.new_status) {
            this.classList.remove("btn-secondary");
            this.classList.add("btn-success");
            this.textContent = "🟢 متوفر";
          } else {
            this.classList.remove("btn-success");
            this.classList.add("btn-secondary");
            this.textContent = "🔴 غير متوفر";
          }
        } else {
          alert("حصل خطأ أثناء تحديث الحالة");
        }
      })
      .catch(err => {
        console.error(err);
        alert("حدث خطأ في الاتصال بالسيرفر");
      });
    });
  });
});
</script>
{% endblock %}
