{% extends "orders/base.html" %}
{% block title %}Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>

  <!-- ğŸ”½ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù„ÙŠ Ù‡ÙŠØ¸Ù‡Ø± -->
  <form method="get" class="mb-3 d-flex gap-2 align-items-center flex-wrap" id="filterForm">
    <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„:</label>

    <select name="table" class="form-select" style="max-width:200px;" onchange="this.form.submit()">
      <option value="categories" {% if selected_table == "categories" %}selected{% endif %}>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
      <option value="products" {% if selected_table == "products" %}selected{% endif %}>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</option>
      <option value="branches" {% if selected_table == "branches" %}selected{% endif %}>Ø§Ù„ÙØ±ÙˆØ¹</option>
    </select>

    {% if selected_table == "products" %}
      <!-- âœ… Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
      <div class="d-flex align-items-center gap-2 flex-nowrap overflow-auto" style="white-space: nowrap;">
        <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <select id="categorySelect" name="category" class="form-select" style="max-width:200px;" onchange="this.form.submit()">
          <option value="">-- ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© --</option>
          {% for c in categories %}
            <option value="{{ c.id }}" {% if selected_category == c.id|stringformat:"s" %}selected{% endif %}>
              {{ c.name }}
            </option>
          {% endfor %}
        </select>

        <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ -->
        <select id="subcategorySelect" name="subcategory" class="form-select" style="max-width:200px;" onchange="this.form.submit()">
          <option value="">-- ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© --</option>
          {% for s in second_categories %}
            {% if not selected_category or s.main_category.id|stringformat:"s" == selected_category %}
              <option value="{{ s.id }}" {% if selected_subcategory == s.id|stringformat:"s" %}selected{% endif %}>
                {{ s.name }}
              </option>
            {% endif %}
          {% endfor %}
        </select>

        <!-- ğŸŸ¢ ÙÙ„ØªØ± Ø§Ù„ØªÙˆÙØ± -->
        <select name="availability" class="form-select" style="max-width:170px;" onchange="this.form.submit()">
          <option value="available" {% if availability == "available" %}selected{% endif %}>ğŸŸ¢ Ø§Ù„Ù…ØªÙˆÙØ± ÙÙ‚Ø·</option>
          <option value="unavailable" {% if availability == "unavailable" %}selected{% endif %}>ğŸ”´ ØºÙŠØ± Ø§Ù„Ù…ØªÙˆÙØ± ÙÙ‚Ø·</option>
          <option value="all" {% if availability == "all" %}selected{% endif %}>âšª Ø§Ù„ÙƒÙ„</option>
        </select>

        <!-- ğŸ” Ø§Ù„Ø¨Ø­Ø« -->
        <input type="text" name="q" class="form-control  flex-shrink-0" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..."value="{{ query|default:'' }}" style="max-width:220px; min-width:180px;">
      </div>
    {% endif %}
  </form>

  <!-- âœ… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
  {% if selected_table == "categories" %}
    <h5>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h5>
    <table class="table table-striped table-bordered">
      <thead class="table-primary">
        <tr>
          <th>#</th>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„ÙˆØµÙ</th>
          <th>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody>
        {% for c in categories %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ c.name }}</td>
            <td>{{ c.description }}</td>
            <td>{{ c.updated_at|date:"Y-m-d H:i" }}</td>
            <td>
              <a href="{% url 'edit_category' c.id %}?table={{ selected_table }}" class="btn btn-sm btn-warning">âœï¸ ØªØ¹Ø¯ÙŠÙ„</a>
              <form method="post" class="delete-form d-inline">
                {% csrf_token %}
                <input type="hidden" name="delete_category" value="{{ c.id }}">
                <button type="submit" class="btn btn-sm btn-danger">ğŸ—‘ Ø­Ø°Ù</button>
              </form>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù…</td></tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <!-- âœ… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
  {% if selected_table == "products" %}
    <h5>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h5>
    <table class="table table-striped table-bordered align-middle text-center">
      <thead class="table-success">
        <tr>
          <th>#</th>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</th>
          <th>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ</th>
          <th>Ø§Ù„Ø³Ø¹Ø±</th>
          <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody>
        {% for p in products %}
          <tr class="{% if not p.is_available %}table-secondary{% endif %}">
            <td>{{ forloop.counter }}</td>
            <td>{{ p.name }}</td>
            <td>{{ p.category.name|default:"â€”" }}</td>
            <td>{{ p.second_category.name|default:"â€”" }}</td>
            <td>{{ p.price }}</td>
            <td>{{ p.get_unit_display }}</td>
            <td>{% if p.is_available %}âœ… Ù…ØªÙˆÙØ±{% else %}âŒ ØºÙŠØ± Ù…ØªÙˆÙØ±{% endif %}</td>
            <td>{{ p.updated_at|date:"Y-m-d H:i" }}</td>
            <td>
              <!-- âœï¸ ØªØ¹Ø¯ÙŠÙ„ -->
              <a href="{% url 'edit_product' p.id %}?table={{ selected_table }}&q={{ query }}&category={{ selected_category }}&subcategory={{ selected_subcategory }}"
                 class="btn btn-sm btn-warning mb-1">âœï¸ ØªØ¹Ø¯ÙŠÙ„</a>

              <!-- ğŸ—‘ Ø­Ø°Ù -->
              <form method="post" class="delete-form d-inline">
                {% csrf_token %}
                <input type="hidden" name="delete_product" value="{{ p.id }}">
                <button type="submit" class="btn btn-sm btn-danger mb-1">ğŸ—‘ Ø­Ø°Ù</button>
              </form>

              <!-- ğŸ” ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªÙˆÙØ± -->
              <button type="button"
                      class="btn btn-sm toggle-btn {% if p.is_available %}btn-success{% else %}btn-secondary{% endif %}"
                      data-id="{{ p.id }}">
                {% if p.is_available %}ğŸŸ¢ Ù…ØªÙˆÙØ±{% else %}ğŸ”´ ØºÙŠØ± Ù…ØªÙˆÙØ±{% endif %}
              </button>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="9" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</td></tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <!-- âœ… Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ±ÙˆØ¹ -->
  {% if selected_table == "branches" %}
    <h5>Ø§Ù„ÙØ±ÙˆØ¹</h5>
    <table class="table table-striped table-bordered">
      <thead class="table-info">
        <tr>
          <th>#</th>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
          <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
          <th>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody>
        {% for b in branches %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ b.name }}</td>
            <td>{{ b.address }}</td>
            <td>{{ b.phone }}</td>
            <td>{{ b.updated_at|date:"Y-m-d H:i" }}</td>
            <td>
              <a href="{% url 'edit_branch' b.id %}?table={{ selected_table }}" class="btn btn-sm btn-warning">âœï¸ ØªØ¹Ø¯ÙŠÙ„</a>
              <form method="post" class="delete-form d-inline">
                {% csrf_token %}
                <input type="hidden" name="delete_branch" value="{{ b.id }}">
                <button type="submit" class="btn btn-sm btn-danger">ğŸ—‘ Ø­Ø°Ù</button>
              </form>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆØ¹</td></tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
</div>

<!-- ğŸ”½ JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById("filterForm");
    const categorySelect = document.getElementById("categorySelect");
    const subcategorySelect = document.getElementById("subcategorySelect");
    const searchInput = document.getElementById("searchInput");

    // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    categorySelect?.addEventListener("change", function() {
      const mainId = this.value;
      subcategorySelect.innerHTML = '<option value="">-- ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© --</option>';
      if (mainId) {
        fetch(`/get-subcategories/?main_id=${mainId}`)
          .then(res => res.json())
          .then(data => {
            data.forEach(sub => {
              const option = document.createElement("option");
              option.value = sub.id;
              option.textContent = sub.name;
              subcategorySelect.appendChild(option);
            });
          })
          .finally(() => form.submit());
      } else {
        form.submit();
      }
    });

    // âœ… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
    let timer;
    searchInput?.addEventListener("input", function() {
      clearTimeout(timer);
      timer = setTimeout(() => form.submit(), 500);
    });

    // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ
    subcategorySelect?.addEventListener("change", function() {
      form.submit();
    });

    // âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù
    document.querySelectorAll(".delete-form").forEach(formEl => {
      formEl.addEventListener("submit", function(e) {
        e.preventDefault();
        Swal.fire({
          title: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ",
          text: "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "ğŸ—‘ Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù",
          cancelButtonText: "Ø¥Ù„ØºØ§Ø¡"
        }).then((result) => {
          if (result.isConfirmed) this.submit();
        });
      });
    });
  });
// -------------------------------------------------------------------------------------------------------
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll(".toggle-btn").forEach(btn => {
    btn.addEventListener("click", function() {
      const productId = this.dataset.id;
      fetch(`/toggle-product/${productId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
        },
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // âœ… ØºÙŠÙ‘Ø± Ø´ÙƒÙ„ Ø§Ù„Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          if (data.new_status) {
            this.classList.remove("btn-secondary");
            this.classList.add("btn-success");
            this.textContent = "ğŸŸ¢ Ù…ØªÙˆÙØ±";
          } else {
            this.classList.remove("btn-success");
            this.classList.add("btn-secondary");
            this.textContent = "ğŸ”´ ØºÙŠØ± Ù…ØªÙˆÙØ±";
          }
        } else {
          alert("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
        }
      })
      .catch(err => {
        console.error(err);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
      });
    });
  });
});
</script>
{% endblock %}
